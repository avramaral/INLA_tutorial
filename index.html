<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="André V. Ribeiro Amaral">

<title>INLA Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#inla" id="toc-inla" class="nav-link active" data-scroll-target="#inla">INLA</a></li>
  <li><a href="#multiple-linear-regression" id="toc-multiple-linear-regression" class="nav-link" data-scroll-target="#multiple-linear-regression">Multiple linear regression</a></li>
  <li><a href="#generalized-linear-models-for-disease-mapping" id="toc-generalized-linear-models-for-disease-mapping" class="nav-link" data-scroll-target="#generalized-linear-models-for-disease-mapping">Generalized linear models (for disease mapping)</a>
  <ul class="collapse">
  <li><a href="#no-random-effects" id="toc-no-random-effects" class="nav-link" data-scroll-target="#no-random-effects">No random effects</a></li>
  <li><a href="#iid-model" id="toc-iid-model" class="nav-link" data-scroll-target="#iid-model">IID model</a></li>
  <li><a href="#intrinsic-conditional-auto-regressive-icar-model" id="toc-intrinsic-conditional-auto-regressive-icar-model" class="nav-link" data-scroll-target="#intrinsic-conditional-auto-regressive-icar-model">Intrinsic Conditional Auto-Regressive (ICAR) model</a></li>
  <li><a href="#bym2-model" id="toc-bym2-model" class="nav-link" data-scroll-target="#bym2-model">BYM2 model</a>
  <ul class="collapse">
  <li><a href="#penalized-complexity-pc-priors" id="toc-penalized-complexity-pc-priors" class="nav-link" data-scroll-target="#penalized-complexity-pc-priors">Penalized Complexity (PC) priors</a></li>
  </ul></li>
  <li><a href="#fitted-values" id="toc-fitted-values" class="nav-link" data-scroll-target="#fitted-values">Fitted values</a></li>
  </ul></li>
  <li><a href="#spatio-temporal-models" id="toc-spatio-temporal-models" class="nav-link" data-scroll-target="#spatio-temporal-models">Spatio-temporal models</a>
  <ul class="collapse">
  <li><a href="#replicates" id="toc-replicates" class="nav-link" data-scroll-target="#replicates">Replicates</a></li>
  <li><a href="#additive-model" id="toc-additive-model" class="nav-link" data-scroll-target="#additive-model">Additive model</a></li>
  <li><a href="#kronecker-product-model" id="toc-kronecker-product-model" class="nav-link" data-scroll-target="#kronecker-product-model">Kronecker product model</a></li>
  <li><a href="#bernardinelli-model" id="toc-bernardinelli-model" class="nav-link" data-scroll-target="#bernardinelli-model">Bernardinelli model</a></li>
  </ul></li>
  <li><a href="#geostatistical-data" id="toc-geostatistical-data" class="nav-link" data-scroll-target="#geostatistical-data">Geostatistical data</a>
  <ul class="collapse">
  <li><a href="#pm2.5" id="toc-pm2.5" class="nav-link" data-scroll-target="#pm2.5">PM2.5</a>
  <ul class="collapse">
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">Prediction</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#point-processes" id="toc-point-processes" class="nav-link" data-scroll-target="#point-processes">Point processes</a>
  <ul class="collapse">
  <li><a href="#pm2.5-stations" id="toc-pm2.5-stations" class="nav-link" data-scroll-target="#pm2.5-stations">PM2.5 stations</a>
  <ul class="collapse">
  <li><a href="#prediction-1" id="toc-prediction-1" class="nav-link" data-scroll-target="#prediction-1">Prediction</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#preferential-sampling-ps" id="toc-preferential-sampling-ps" class="nav-link" data-scroll-target="#preferential-sampling-ps">Preferential sampling (PS)</a>
  <ul class="collapse">
  <li><a href="#pm2.5-1" id="toc-pm2.5-1" class="nav-link" data-scroll-target="#pm2.5-1">PM2.5</a>
  <ul class="collapse">
  <li><a href="#prediction-2" id="toc-prediction-2" class="nav-link" data-scroll-target="#prediction-2">Prediction</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#one-more-thing-spat.-varying-ps" id="toc-one-more-thing-spat.-varying-ps" class="nav-link" data-scroll-target="#one-more-thing-spat.-varying-ps">One more thing (Spat. varying PS)</a>
  <ul class="collapse">
  <li><a href="#pm2.5-2" id="toc-pm2.5-2" class="nav-link" data-scroll-target="#pm2.5-2">PM2.5</a>
  <ul class="collapse">
  <li><a href="#prediction-3" id="toc-prediction-3" class="nav-link" data-scroll-target="#prediction-3">Prediction</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">INLA Tutorial</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://www.avramaral.com/">André V. Ribeiro Amaral</a> </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p><i class="fa-brands fa-github" aria-label="github"></i> <a href="https://github.com/avramaral/INLA_tutorial" style="text-decoration:none;">GitHub repository</a></p>
<p>In this tutorial, we will use the following <code>R</code> packages.</p>
<div class="cell" data-result="hide">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"INLA"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spatstat"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"raster"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sf"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"rgeos"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"MASS"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spdep"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"patchwork"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To install <code>INLA</code>, you can follow the instruction <a href="https://www.r-inla.org/download-install">here</a>. Alternatively,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"INLA"</span>, <span class="at">repos =</span> <span class="fu">c</span>(<span class="fu">getOption</span>(<span class="st">"repos"</span>), <span class="at">INLA =</span> <span class="st">"https://inla.r-inla-download.org/R/stable"</span>), <span class="at">dep =</span> <span class="cn">TRUE</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Along the tutorial, we will use the following common theme and colors for the plots with <code>ggplot2</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#00008FFF"</span>, <span class="st">"#0000F2FF"</span>, <span class="st">"#0063FFFF"</span>, <span class="st">"#00D4FFFF"</span>, <span class="st">"#46FFB8FF"</span>, <span class="st">"#B8FF46FF"</span>, <span class="st">"#FFD400FF"</span>, <span class="st">"#FF6300FF"</span>, <span class="st">"#F00000FF"</span>, <span class="st">"#800000FF"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>custom_theme <span class="ot">&lt;-</span>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="inla" class="level1">
<h1>INLA</h1>
<p>In a nutshell, the integrated nested Laplace approximation (INLA) (<a href="https://doi.org/10.1111/j.1467-9868.2008.00700.x">Rue et al., 2009</a>) method is used to approximate Bayesian inference in latent Gaussian models. In particular, it can be used to fit models of the form <span class="math display">\begin{align*}
    y_i|S(x_i), &amp;\theta \sim \pi(y_i|S(x_i), \theta), \text{ for } i \in \{1, \cdots, n\} \\
    S(x)|\theta &amp;\sim \text{Normal}(\mu(\theta), Q(\theta)^{-1}) \\
    \theta &amp;\sim \pi(\theta),
\end{align*}</span> where <span class="math inline">y = (y_1, \ldots, y_n)</span> is the vector or observed values, <span class="math inline">x = (x_1, \ldots, x_n)</span> is a Gaussian random field, and <span class="math inline">\theta = (\theta_1, \ldots, \theta_k)</span>, for some <span class="math inline">k \in \mathbb{N}</span>, is a vector of hyperparameters. <span class="math inline">\mu(\theta)</span> and <span class="math inline">Q(\theta)</span> represent the mean vector and the precision matrix, respectively.</p>
<p>The observed values <span class="math inline">y_i</span>, <span class="math inline">\forall i</span>, are assumed to have mean <span class="math inline">\mu_i=g^{-1}(\eta_i)</span>, such that the linear prediction <span class="math inline">\eta_i</span> can be expressed as follows <span class="math display">\begin{align*}
  \eta_i = \alpha + \sum^{n_{\beta}}_{k = 1} \beta_k z_{ki} + \sum_{j = 1}^{n_f}f^{(j)}(u_{ij}) + \varepsilon_i, \forall i,
\end{align*}</span> where <span class="math inline">\alpha</span> is the intercept, <span class="math inline">\{\beta_k\}_k</span>, are the coefficients of covariates <span class="math inline">\{z_{ki}\}_{ki}</span>, and <span class="math inline">\{f^{(j)}\}_j</span> define some random effects in terms of covariates <span class="math inline">\{u_{ij}\}_{ij}</span>. Lastly, <span class="math inline">\varepsilon_i</span> is an error term.</p>
<p>In this formulation, <span class="math inline">\{f^{(j)}\}_j</span> will be commonly defined as spatio(-temporal) structures—at least for the purposes of this tutorial.</p>
</section>
<section id="multiple-linear-regression" class="level1">
<h1>Multiple linear regression</h1>
<p>Let us start with a multiple linear regression problem, so that we can get to know the <code>INLA</code> notation and how to extract the desired quantities. This example was extracted from <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLA.html#multiple-linear-regression">Bayesian Inference with INLA</a> (<a href="https://becarioprecario.bitbucket.io/inla-gitbook/index.html">Gómez-Rubio, 2021</a>).</p>
<p>We will analyze the <code>cement</code> data set from the <code>MASS</code> package. <code>x1</code>, <code>x2</code>, <code>x3</code>, and <code>x4</code> represent the percentages of the four main chemical ingredients in the setting of 13 cements, and <code>y</code> measures the heat evolved.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cement)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       x1               x2              x3              x4           y         
 Min.   : 1.000   Min.   :26.00   Min.   : 4.00   Min.   : 6   Min.   : 72.50  
 1st Qu.: 2.000   1st Qu.:31.00   1st Qu.: 8.00   1st Qu.:20   1st Qu.: 83.80  
 Median : 7.000   Median :52.00   Median : 9.00   Median :26   Median : 95.90  
 Mean   : 7.462   Mean   :48.15   Mean   :11.77   Mean   :30   Mean   : 95.42  
 3rd Qu.:11.000   3rd Qu.:56.00   3rd Qu.:17.00   3rd Qu.:44   3rd Qu.:109.20  
 Max.   :21.000   Max.   :71.00   Max.   :23.00   Max.   :60   Max.   :115.90  </code></pre>
</div>
</div>
<p>Let us add another data point for prediction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cement <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cement, <span class="fu">data.frame</span>(<span class="at">x1 =</span> <span class="dv">24</span>, <span class="at">x2 =</span> <span class="dv">24</span>, <span class="at">x3 =</span> <span class="dv">24</span>, <span class="at">x4 =</span> <span class="dv">24</span>, <span class="at">y  =</span> <span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And let us fit the following model <span class="math display">\begin{align*}
y_i = \alpha + \sum_{j = 1}^{4} \beta_j x_{ji} + \varepsilon_i, \forall i,
\end{align*}</span> where <span class="math inline">\varepsilon_i\overset{\text{i.i.d.}}{\sim}\text{Normal}(0, 1/\tau)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_1_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data    =</span> cement,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)) <span class="co"># Should the marginals for the linear predictor be computed?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.98, Running = 0.553, Post = 0.0266, Total = 2.56 
Fixed effects:
              mean     sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) 62.503 68.255    -73.838   62.492    198.907 62.494   0
x1           1.550  0.725      0.100    1.550      2.999  1.550   0
x2           0.509  0.705     -0.900    0.509      1.918  0.509   0
x3           0.101  0.735     -1.368    0.101      1.569  0.101   0
x4          -0.145  0.691     -1.525   -0.145      1.235 -0.145   0

Model hyperparameters:
                                         mean    sd 0.025quant 0.5quant
Precision for the Gaussian observations 0.209 0.093      0.069    0.195
                                        0.975quant  mode
Precision for the Gaussian observations      0.428 0.168

Marginal log-Likelihood:  -59.58 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model_1_1$summary.fixed              # Estimated fixed effects</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># model_1_1$summary.hyperpar           # Estimated hyperparameters</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># model_1_1$summary.linear.predictor   # Estimated values for the linear predictor</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>model_1_1<span class="sc">$</span>summary.fitted.values[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># Fitted values (+ prediction)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         mean        sd 0.025quant  0.5quant 0.975quant
fitted.Predictor.01  78.49487 1.7599239   74.97938  78.49473   82.01162
fitted.Predictor.02  72.78996 1.3694565   70.05488  72.78971   75.52689
fitted.Predictor.03 105.97348 1.8005797  102.37782 105.97307  109.57220
fitted.Predictor.04  89.32802 1.2889907   86.75361  89.32781   91.90409
fitted.Predictor.05  95.64936 1.4188557   92.81527  95.64921   98.48472
fitted.Predictor.06 105.27493 0.8360121  103.60514 105.27482  106.94566
fitted.Predictor.07 104.14886 1.4375734  101.27740 104.14870  107.02165
fitted.Predictor.08  75.67461 1.5164313   72.64548  75.67450   78.70480
fitted.Predictor.09  91.72304 1.2866716   89.15342  91.72278   94.29458
fitted.Predictor.10 115.61786 1.9856102  111.65149 115.61772  119.58554
fitted.Predictor.11  81.80842 1.5474777   78.71723  81.80833   84.90056
fitted.Predictor.12 112.32632 1.2164048  109.89641 112.32627  114.75683
fitted.Predictor.13 111.69378 1.3073368  109.08228 111.69371  114.30606
fitted.Predictor.14 110.86481 5.9359151   99.00816 110.86418  122.72683</code></pre>
</div>
</div>
<p><code>INLA</code> has numerous functions to process the posterior marginals. For instance, <code>inla.smarginal()</code> is used to obtain a spline smoothing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> model_1_1<span class="sc">$</span>marginals.fixed[[<span class="dv">1</span>]]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(alpha)), <span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of alpha"</span>) <span class="sc">+</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>inla.qmarginal()</code> and <code>inla.pmarginal()</code> compute the quantile and distribution function, respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>qq <span class="ot">&lt;-</span> <span class="fu">inla.qmarginal</span>(<span class="fl">0.05</span>, alpha)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -48.42291</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inla.pmarginal</span>(qq, alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05</code></pre>
</div>
</div>
<p><code>inla.dmarginal()</code> computes the density at particular values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inla.dmarginal</span>(<span class="dv">0</span>, alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003704535</code></pre>
</div>
</div>
<p><code>inla.tmarginal()</code> transforms the marginal. This is useful, e.g., to obtain the posterior distribution of the <span class="math inline">1 / \tau</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sigma_2 <span class="ot">&lt;-</span> <span class="fu">inla.tmarginal</span>(<span class="at">fun =</span> <span class="cf">function</span>(x) { <span class="dv">1</span> <span class="sc">/</span> x }, <span class="at">marginal =</span> model_1_1<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">Precision for the Gaussian observations</span><span class="st">`</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(sigma_2))) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of the variance"</span>) <span class="sc">+</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Complementary, we can also plot the posterior distribution of the fitted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span> model_1_1<span class="sc">$</span>marginals.fitted.values</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>post_margin <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">do.call</span>(rbind, post_fitted))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>post_margin<span class="sc">$</span>cement <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">names</span>(post_fitted), <span class="at">times =</span> <span class="fu">sapply</span>(post_fitted, nrow))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(post_margin) <span class="sc">+</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> cement, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="generalized-linear-models-for-disease-mapping" class="level1">
<h1>Generalized linear models (for disease mapping)</h1>
<p>Next, let us fit a generalized linear model (GLM) for a problem in disease mapping. Initially, we will ignore the underlying spatial structure, but we will consider it in the following part. This example was extracted from <a href="https://www.paulamoraga.com/book-geospatial/sec-arealdataexamplest.html">Geospatial Health Data: Modeling and Visualization with R-INLA and Shiny</a> (<a href="https://www.paulamoraga.com/book-geospatial/index.html">Moraga, 2019</a>).</p>
<p>We will model the number of cases of lung cancer in Ohio, USA, from 1968 to 1988. The data can be downloaded from <a href="https://github.com/avramaral/INLA_tutorial/raw/main/data/example_2/example_2_data.zip">here</a>.</p>
<p>After downloading the data, we can do the following</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>d_ohio <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">"data/example_2/data_ohio.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>m_ohio <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="at">dsn =</span> <span class="st">"data/example_2/ohio_shapefile/"</span>, <span class="at">layer =</span> <span class="st">"fe_2007_39_county"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_ohio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  county gender  race  year     y     n NAME 
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
1      1      1     1  1968     6  8912 Adams
2      1      1     1  1969     5  9139 Adams
3      1      1     1  1970     8  9455 Adams
4      1      1     1  1971     5  9876 Adams
5      1      1     1  1972     8 10281 Adams
6      1      1     1  1973     5 10876 Adams</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m_ohio<span class="sc">$</span>geometry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For this problem, we would like to model the relative risk of cancer in a certain region. To do so, we can compute first the “standardized incidence ratio” (SIR).</p>
<p>Let <span class="math inline">Y_i</span> denote the number of cases in the location <span class="math inline">i</span>, then <span class="math display">\begin{align*}
  \text{SIR}_i = \frac{Y_i}{E_i}, \forall i,
\end{align*}</span> where <span class="math display">\begin{align*}
  E_i = \sum_{j = 1}^{m} r_j^{(s)} \cdot n_j^{(i)},
\end{align*}</span> such that <span class="math inline">r_j^{(s)}</span> represents the rate in stratum <span class="math inline">j</span> in the standard population, and <span class="math inline">n_j^{(i)}</span> is the population in stratum <span class="math inline">j</span> of location <span class="math inline">i</span>.</p>
<p>We can compute the SIR as follows (<code>expected()</code> was extracted from the <code>SpatialEpi</code> package)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracted from `SpatialEpi`</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span> <span class="cf">function</span> (population, cases, n.strata, ...) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(population) <span class="sc">/</span> n.strata</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  E <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  qNum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n.strata)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  qDenom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n.strata)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n.strata)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute strata-specific rates</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.strata) {</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">&lt;-</span> <span class="fu">rep</span>(i, n) <span class="sc">+</span> <span class="fu">seq</span>(<span class="dv">0</span>, (n <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">*</span> n.strata</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    qNum[i] <span class="ot">&lt;-</span> qNum[i] <span class="sc">+</span> <span class="fu">sum</span>(cases[indices])</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    qDenom[i] <span class="ot">&lt;-</span> qDenom[i] <span class="sc">+</span> <span class="fu">sum</span>(population[indices])</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> qNum <span class="sc">/</span> qDenom</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute expected counts</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>n.strata) <span class="sc">+</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> n.strata</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    E[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(population[indices] <span class="sc">*</span> q)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  E</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">################</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Process data #</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">################</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed number of cases</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d_ohio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(NAME, year) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Y =</span> <span class="fu">sum</span>(y)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">county =</span> NAME) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(county, year)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected cases </span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>d_ohio <span class="ot">&lt;-</span> d_ohio <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(county, year, gender, race)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>n.strata <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># 2 genders x 2 races </span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">expected</span>(<span class="at">population =</span> d_ohio<span class="sc">$</span>n, <span class="at">cases =</span> d_ohio<span class="sc">$</span>y, <span class="at">n.strata =</span> n.strata)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute SIR</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>n_years    <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d_ohio<span class="sc">$</span>year))</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>n_counties <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d_ohio<span class="sc">$</span>NAME))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>counties_E <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">unique</span>(d_ohio<span class="sc">$</span>NAME), <span class="at">each =</span> n_years)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>years_E    <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">unique</span>(d_ohio<span class="sc">$</span>year), <span class="at">times =</span> n_counties)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>d_E <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">county =</span> counties_E, <span class="at">year =</span> years_E, <span class="at">E =</span> E)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(<span class="at">y =</span> d_E, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>))</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">SIR =</span> Y <span class="sc">/</span> E)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Link map  information</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>d_wide <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, <span class="at">values_from =</span> <span class="fu">c</span>(Y, E, SIR), <span class="at">names_glue =</span> <span class="st">"{.value}.{year}"</span>) <span class="co"># `wide` format</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>m_ohio <span class="ot">&lt;-</span> m_ohio <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">county =</span> NAME) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(<span class="at">y =</span> d_wide, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"county"</span>)) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="fu">colnames</span>(d_wide), <span class="st">"geometry"</span>))</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>s_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(m_ohio), <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"geometry"</span>)) <span class="co"># to `long` format</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>m_ohio <span class="ot">&lt;-</span> m_ohio <span class="sc">%&gt;%</span> </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">all_of</span>(s_cols), <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"year"</span>), <span class="at">names_sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(county, year, Y, E, SIR, geometry) <span class="sc">%&gt;%</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>          <span class="fu">arrange</span>(county, year)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(m_ohio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 5 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -83.70532 ymin: 38.59659 xmax: -83.26755 ymax: 39.0552
Geodetic CRS:  NAD83
# A tibble: 6 × 6
  county  year     Y     E   SIR                                        geometry
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;                                   &lt;POLYGON [°]&gt;
1 Adams   1968     6  8.28 0.725 ((-83.67511 38.99929, -83.67486 38.99965, -83.…
2 Adams   1969     5  8.50 0.588 ((-83.67511 38.99929, -83.67486 38.99965, -83.…
3 Adams   1970     9  8.78 1.03  ((-83.67511 38.99929, -83.67486 38.99965, -83.…
4 Adams   1971     6  9.18 0.654 ((-83.67511 38.99929, -83.67486 38.99965, -83.…
5 Adams   1972    10  9.55 1.05  ((-83.67511 38.99929, -83.67486 38.99965, -83.…
6 Adams   1973     7 10.1  0.693 ((-83.67511 38.99929, -83.67486 38.99965, -83.…</code></pre>
</div>
</div>
<p>Now, we can plot the computed SIR for all locations for all years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(m_ohio) <span class="sc">+</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> SIR)) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> year, <span class="at">ncol =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">name =</span> <span class="st">"SIR"</span>, <span class="at">midpoint =</span> <span class="dv">1</span>, <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>However, if there exist locations with small population or expected counts, SIR may be unreliable. To overcome this issue, we will model the relative risk as follows</p>
<p><span class="math display">\begin{align*}
Y_i &amp;\sim \text{Poisson}(E_i \theta_i), \forall i,\\
\log(\theta_i) &amp;= \alpha + \sum_{j = 1}^{n_f}f^{(j)}(u_{ij})
\end{align*}</span> where the relative risk <span class="math inline">\theta_i</span> quantifies whether the location <span class="math inline">i</span> has higher (<span class="math inline">&gt;1</span>) or lower (<span class="math inline">&lt;1</span>) risk than the average risk in the standard population. We will experiment with different structures (if any) for the random effects.</p>
<p>Aiming to implement the random effects, let us include an index for area and time in our data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create indices for random effects</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>m_ohio <span class="ot">&lt;-</span> m_ohio <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id_area =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(county)),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">id_time =</span> (<span class="dv">1</span> <span class="sc">+</span> year <span class="sc">-</span> <span class="fu">min</span>(year)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we will with data corresponding to <span class="math inline">1988</span> only (we will consider a spatio-temporal structure later).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> m_ohio <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">1988</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="no-random-effects" class="level2">
<h2 class="anchored" data-anchor-id="no-random-effects">No random effects</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>model_2_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E, <span class="co"># Known component in the mean for the Poisson likelihoods</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.compute   =</span> <span class="fu">list</span>(<span class="at">cpo  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">dic  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">waic =</span> <span class="cn">TRUE</span>)) <span class="co"># For model comparison</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we are computing <code>cpo</code>, <code>dic</code>, and <code>waic</code>, so that we can compare models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.09, Running = 0.524, Post = 0.0224, Total = 2.64 
Fixed effects:
             mean    sd 0.025quant 0.5quant 0.975quant  mode kld
(Intercept) 0.279 0.012      0.254    0.279      0.303 0.279   0

Deviance Information Criterion (DIC) ...............: 778.76
Deviance Information Criterion (DIC, saturated) ....: 303.57
Effective number of parameters .....................: 1.00

Watanabe-Akaike information criterion (WAIC) ...: 783.13
Effective number of parameters .................: 5.02

Marginal log-Likelihood:  -391.85 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>For later use, let us create the function <code>table_model_comparison</code> to print a table for model comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>table_model_comparison <span class="ot">&lt;-</span> <span class="cf">function</span> (models, ...) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  n_models <span class="ot">&lt;-</span> <span class="fu">length</span>(models)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="at">data =</span> <span class="dv">0</span>, <span class="at">nrow =</span> n_models, <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(df) <span class="ot">&lt;-</span> <span class="fu">names</span>(models)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CPO"</span>, <span class="st">"DIC"</span>, <span class="st">"WAIC"</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_models) {</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    tmp_CPO  <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">log</span>(models[[i]]<span class="sc">$</span>cpo<span class="sc">$</span>cpo)) <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    tmp_DIC  <span class="ot">&lt;-</span> models[[i]]<span class="sc">$</span>dic<span class="sc">$</span>dic</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    tmp_WAIC <span class="ot">&lt;-</span> models[[i]]<span class="sc">$</span>waic<span class="sc">$</span>waic</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    df[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(tmp_CPO, tmp_DIC, tmp_WAIC)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="iid-model" class="level2">
<h2 class="anchored" data-anchor-id="iid-model">IID model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"iid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Y ~ 0 + 1 + f(id_area, model = "iid")</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_2_2 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_2,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E, </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.compute   =</span> <span class="fu">list</span>(<span class="at">cpo  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">dic  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">waic =</span> <span class="cn">TRUE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.8, Running = 0.521, Post = 0.0273, Total = 2.35 
Fixed effects:
             mean    sd 0.025quant 0.5quant 0.975quant  mode kld
(Intercept) 0.198 0.032      0.134    0.198      0.259 0.198   0

Random effects:
  Name    Model
    id_area IID model

Model hyperparameters:
                       mean   sd 0.025quant 0.5quant 0.975quant  mode
Precision for id_area 19.94 5.20      11.86    19.23      32.05 17.94

Deviance Information Criterion (DIC) ...............: 626.58
Deviance Information Criterion (DIC, saturated) ....: 151.39
Effective number of parameters .....................: 55.70

Watanabe-Akaike information criterion (WAIC) ...: 624.54
Effective number of parameters .................: 40.09

Marginal log-Likelihood:  -346.57 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model comparison</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table_model_comparison</span>(<span class="at">models =</span> <span class="fu">list</span>(<span class="at">model_2_1 =</span> model_2_1, <span class="at">model_2_2 =</span> model_2_2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               CPO      DIC     WAIC
model_2_1 391.6097 778.7631 783.1293
model_2_2 354.8703 626.5815 624.5403</code></pre>
</div>
</div>
</section>
<section id="intrinsic-conditional-auto-regressive-icar-model" class="level2">
<h2 class="anchored" data-anchor-id="intrinsic-conditional-auto-regressive-icar-model">Intrinsic Conditional Auto-Regressive (ICAR) model</h2>
<p>Alternatively, we can also account for the spatial dependence that may exist underlying our observed counts.</p>
<p>To do so, the first thing we have to do is determining the neighboring structure for the analyzed region. This can be done by using the <code>poly2nb()</code> function from the <code>spdep</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(data<span class="sc">$</span>geometry)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1]  8 36 66 73

[[2]]
[1]  6 32 33 69 81

[[3]]
[1] 38 39 42 47 52 70 85

[[4]]
[1] 28 43 78

[[5]]
[1] 37 53 58 64 82 84

[[6]]
[1]  2 33 46 54 75 81</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save matrix for later use within INLA</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nb2INLA</span>(<span class="st">"data/example_2/map.adj"</span>, nb)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">inla.read.graph</span>(<span class="at">filename =</span> <span class="st">"data/example_2/map.adj"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can fit a <code>iid + besag</code> model.</p>
<p><strong>Remark:</strong> in <code>INLA</code>, we can always use <code>inla.doc()</code> to view the documentation (e.g., parameterization) of models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: `besag`</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inla.doc</span>(<span class="st">"besag"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, we are fitting a model such that</p>
<p><span class="math display">\begin{align*}
\log(\theta_i) = \alpha + u_i + v_i,
\end{align*}</span> such that <span class="math inline">u_i</span> is a random effect specific to area <span class="math inline">i</span> to model spatial dependence between the relative risks, and <span class="math inline">v_i</span> is an unstructured exchangeable component that models uncorrelated noise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>formula_3 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"iid"</span>) <span class="sc">+</span> <span class="fu">f</span>(id_area_cp, <span class="at">model =</span> <span class="st">"besag"</span>, <span class="at">graph =</span> g, <span class="at">scale.model =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>scale.model = TRUE</code> makes the model to be scaled to have an average variance of 1 (<a href="https://www.sciencedirect.com/science/article/pii/S2211675313000407">Sorbye and Rue, 2014</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>model_2_3 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_3,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.compute   =</span> <span class="fu">list</span>(<span class="at">cpo  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">dic  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">waic =</span> <span class="cn">TRUE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.98, Running = 0.639, Post = 0.0361, Total = 2.66 
Fixed effects:
             mean    sd 0.025quant 0.5quant 0.975quant  mode kld
(Intercept) 0.199 0.031      0.136    0.199      0.258 0.199   0

Random effects:
  Name    Model
    id_area IID model
   id_area_cp Besags ICAR model

Model hyperparameters:
                             mean       sd 0.025quant 0.5quant 0.975quant  mode
Precision for id_area       22.96 8.33e+00       9.90    21.84      42.20 19.75
Precision for id_area_cp 11242.10 1.45e+05      20.52   501.77   64005.04 39.29

Deviance Information Criterion (DIC) ...............: 625.86
Deviance Information Criterion (DIC, saturated) ....: 150.66
Effective number of parameters .....................: 55.11

Watanabe-Akaike information criterion (WAIC) ...: 624.05
Effective number of parameters .................: 39.85

Marginal log-Likelihood:  -370.33 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model comparison</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table_model_comparison</span>(<span class="at">models =</span> <span class="fu">list</span>(<span class="at">model_2_1 =</span> model_2_1, <span class="at">model_2_2 =</span> model_2_2, <span class="at">model_2_3 =</span> model_2_3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               CPO      DIC     WAIC
model_2_1 391.6097 778.7631 783.1293
model_2_2 354.8703 626.5815 624.5403
model_2_3 352.9770 625.8572 624.0514</code></pre>
</div>
</div>
</section>
<section id="bym2-model" class="level2">
<h2 class="anchored" data-anchor-id="bym2-model">BYM2 model</h2>
<p>As an alternative to <code>iid + besag</code>, we can fit a “Besag, York, and Mollié” (BYM2) model. In this case, we reparameterize the structured <span class="math inline">u = (u_1, \cdots, u_n)</span> and unstructured <span class="math inline">v = (v_1, \cdots, v_n)</span> random effects as follows <span class="math display">\begin{align*}
b = u + v = \frac{1}{\sqrt{\tau_b}}(\sqrt{1 - \phi}v^{\star} + \sqrt{\phi}u^{\star}),
\end{align*}</span> where <span class="math inline">\tau_b &gt; 0</span> is the precision, <span class="math inline">0 \leq \phi \leq 1</span> is a mixing parameter, <span class="math inline">v^{\star} \sim \text{Normal}(0, I_n)</span> and <span class="math inline">u^{\star}</span> is a scaled ICAR model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>formula_4 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"bym2"</span>, <span class="at">graph =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>model_2_4 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_4,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.compute   =</span> <span class="fu">list</span>(<span class="at">cpo  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">dic  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">waic =</span> <span class="cn">TRUE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 18.1, Running = 0.608, Post = 0.0354, Total = 18.8 
Fixed effects:
            mean    sd 0.025quant 0.5quant 0.975quant mode kld
(Intercept)  0.2 0.029      0.141      0.2      0.255  0.2   0

Random effects:
  Name    Model
    id_area BYM2 model

Model hyperparameters:
                        mean    sd 0.025quant 0.5quant 0.975quant   mode
Precision for id_area 19.029 4.779     11.389   18.440      30.08 17.302
Phi for id_area        0.301 0.159      0.064    0.276       0.66  0.201

Deviance Information Criterion (DIC) ...............: 623.35
Deviance Information Criterion (DIC, saturated) ....: 148.16
Effective number of parameters .....................: 55.15

Watanabe-Akaike information criterion (WAIC) ...: 619.32
Effective number of parameters .................: 38.26

Marginal log-Likelihood:  -282.48 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model comparison</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table_model_comparison</span>(<span class="at">models =</span> <span class="fu">list</span>(<span class="at">model_2_1 =</span> model_2_1, <span class="at">model_2_2 =</span> model_2_2, <span class="at">model_2_3 =</span> model_2_3, <span class="at">model_2_4 =</span> model_2_4))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               CPO      DIC     WAIC
model_2_1 391.6097 778.7631 783.1293
model_2_2 354.8703 626.5815 624.5403
model_2_3 352.9770 625.8572 624.0514
model_2_4 348.5249 623.3496 619.3207</code></pre>
</div>
</div>
<section id="penalized-complexity-pc-priors" class="level3">
<h3 class="anchored" data-anchor-id="penalized-complexity-pc-priors">Penalized Complexity (PC) priors</h3>
<p>As before, we can also set different priors before fitting our model. In particular, we can set Penalized Complexity (PC) priors for our <code>bym2</code> model.</p>
<p>As in <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-priors.html#sec:pcpriors">Gómez-Rubio (2021)</a>,</p>
<blockquote class="blockquote">
<p>PC priors are designed following some principles for inference. First of all, the prior favors the base model unless evidence is provided against it, following the principle of parsimony. Distance from the base model is measured using the Kullback-Leibler distance, and penalization from the base model is done at a constant rate on the distance. Finally, the PC prior is defined using probability statements on the model parameters in the appropriate scale.</p>
</blockquote>
<p>To define the prior for the marginal precision <span class="math inline">\tau_b</span> we use the probability statement <span class="math inline">\mathbb{P}((1/\sqrt{\tau_b}) &gt; U) = \alpha</span>. A prior for <span class="math inline">\phi</span> is defined using <span class="math inline">\mathbb{P}(\phi &lt; U) = \alpha</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>pc_prior <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">prec =</span> <span class="fu">list</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="st">"pc.prec"</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>)), <span class="co"># P(1 / sqrt(prec) &gt; 1) = 0.01</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">phi =</span> <span class="fu">list</span>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="st">"pc"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>)) <span class="co"># P(phi &lt; 0.5) = 0.75</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From above, notice that <span class="math inline">\mathbb{P}(\phi &lt; 0.5) = 0.75</span> implies that we believe that the unstructured effect accounts for more of the variability than the spatially structured effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>formula_5 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"bym2"</span>, <span class="at">graph =</span> g, <span class="at">hyper =</span> pc_prior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model_2_5 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_5,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E, </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.compute   =</span> <span class="fu">list</span>(<span class="at">cpo  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">dic  =</span> <span class="cn">TRUE</span>, </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">waic =</span> <span class="cn">TRUE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 18.8, Running = 0.582, Post = 0.0354, Total = 19.4 
Fixed effects:
             mean    sd 0.025quant 0.5quant 0.975quant mode kld
(Intercept) 0.199 0.029       0.14      0.2      0.256  0.2   0

Random effects:
  Name    Model
    id_area BYM2 model

Model hyperparameters:
                        mean    sd 0.025quant 0.5quant 0.975quant  mode
Precision for id_area 19.129 4.784     11.489   18.537     30.202 17.39
Phi for id_area        0.264 0.149      0.052    0.238      0.614  0.16

Deviance Information Criterion (DIC) ...............: 623.44
Deviance Information Criterion (DIC, saturated) ....: 148.24
Effective number of parameters .....................: 55.45

Watanabe-Akaike information criterion (WAIC) ...: 619.13
Effective number of parameters .................: 38.26

Marginal log-Likelihood:  -282.44 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model comparison</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table_model_comparison</span>(<span class="at">models =</span> <span class="fu">list</span>(<span class="at">model_2_1 =</span> model_2_1, <span class="at">model_2_2 =</span> model_2_2, <span class="at">model_2_3 =</span> model_2_3, <span class="at">model_2_4 =</span> model_2_4, <span class="at">model_2_5 =</span> model_2_5))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               CPO      DIC     WAIC
model_2_1 391.6097 778.7631 783.1293
model_2_2 354.8703 626.5815 624.5403
model_2_3 352.9770 625.8572 624.0514
model_2_4 348.5249 623.3496 619.3207
model_2_5 349.0522 623.4366 619.1260</code></pre>
</div>
</div>
</section>
</section>
<section id="fitted-values" class="level2">
<h2 class="anchored" data-anchor-id="fitted-values">Fitted values</h2>
<p>Although <code>model_2_4</code> and <code>model_2_5</code> are slightly better, for the purpose of this tutorial, we will plot the fitted values based on <code>model_2_3</code> (<code>iid + besag</code>), so that we can see the estimated unstructured and structured effects separately.</p>
<p>We can retrieve the fitted values by analyzing <code>model_2_3$summary.fitted.values</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fitted_values <span class="ot">&lt;-</span> model_2_3<span class="sc">$</span>summary.fitted.values[, <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"0.025quant"</span>, <span class="st">"0.975quant"</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(<span class="at">id_area =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rename</span>(<span class="at">Mean =</span> mean, <span class="st">`</span><span class="at">0.025</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">0.025quant</span><span class="st">`</span>, <span class="st">`</span><span class="at">0.975</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">0.975quant</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">left_join</span>(<span class="at">y =</span> data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"geometry"</span>, <span class="st">"id_area"</span>)], <span class="at">by =</span> <span class="st">"id_area"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                 dplyr<span class="sc">::</span><span class="fu">select</span>(county, Mean, <span class="st">`</span><span class="at">0.025</span><span class="st">`</span>, <span class="st">`</span><span class="at">0.975</span><span class="st">`</span>, geometry) <span class="sc">%&gt;%</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Mean, <span class="st">`</span><span class="at">0.025</span><span class="st">`</span>, <span class="st">`</span><span class="at">0.975</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"0.025"</span>, <span class="st">"Mean"</span>, <span class="st">"0.975"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">st_as_sf</span>()</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fitted_values) <span class="sc">+</span> </span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">dir =</span> <span class="st">"h"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">name =</span> <span class="st">"Relative risk"</span>, <span class="at">midpoint =</span> <span class="dv">1</span>, <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Estimated </span><span class="sc">\"</span><span class="st">Relative Risk</span><span class="sc">\"</span><span class="st"> in 1988"</span>) <span class="sc">+</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And we can retrieve the summary of the posterior distribution of the random effects by analyzing <code>model_2_3$summary.random</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"geometry"</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="st">"IID"</span> <span class="ot">=</span> model_2_3<span class="sc">$</span>summary.random<span class="sc">$</span>id_area<span class="sc">$</span>mean,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"BESAG"</span> <span class="ot">=</span> model_2_3<span class="sc">$</span>summary.random<span class="sc">$</span>id_area_cp<span class="sc">$</span>mean) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(IID, BESAG)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"IID"</span>, <span class="st">"BESAG"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">st_as_sf</span>()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(random_effects) <span class="sc">+</span> </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">dir =</span> <span class="st">"h"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">name =</span> <span class="st">"RE"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior mean of the random effects"</span>) <span class="sc">+</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="spatio-temporal-models" class="level1">
<h1>Spatio-temporal models</h1>
<p>We will continue analyzing the data set we introduced in the previous section (i.e., number of cases of lung cancer in Ohio, USA, from 1968 to 1988), but now we will also account for the possible temporal dependence that may exist over the years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> m_ohio</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 7 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -83.70532 ymin: 38.59659 xmax: -83.26755 ymax: 39.0552
Geodetic CRS:  NAD83
# A tibble: 6 × 8
  county  year     Y     E   SIR                        geometry id_area id_time
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;                   &lt;POLYGON [°]&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 Adams   1968     6  8.28 0.725 ((-83.67511 38.99929, -83.6748…       1       1
2 Adams   1969     5  8.50 0.588 ((-83.67511 38.99929, -83.6748…       1       2
3 Adams   1970     9  8.78 1.03  ((-83.67511 38.99929, -83.6748…       1       3
4 Adams   1971     6  9.18 0.654 ((-83.67511 38.99929, -83.6748…       1       4
5 Adams   1972    10  9.55 1.05  ((-83.67511 38.99929, -83.6748…       1       5
6 Adams   1973     7 10.1  0.693 ((-83.67511 38.99929, -83.6748…       1       6</code></pre>
</div>
</div>
<p>Similar to before, we will model the relative risk as follows <span class="math display">\begin{align*}
Y_{it} &amp;\sim \text{Poisson}(E_{it} \theta_{it}), \forall i, t, \\
\log(\theta_{it}) &amp;= \alpha + \sum_{j = 1}^{n_f}f^{(j)}(u_{it,j}).
\end{align*}</span> However, notice that now all quantities depend on the year (or time, <span class="math inline">t</span>). The random effects may depend on both space and time with possible interaction.</p>
<section id="replicates" class="level2">
<h2 class="anchored" data-anchor-id="replicates">Replicates</h2>
<p>An alternative to model space-time observations is treating them as replicates. In <code>INLA</code>, using <code>replicate</code> implies that replicated effects share the hyperparameters (only). This means that the values of the random effects in the different replicates can be different (<a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLAfeatures.html#subsec:replicate">Gómez-Rubio, 2021</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"besag"</span>, <span class="at">graph =</span> g, <span class="at">replicate =</span> id_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>model_3_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.26, Running = 3.81, Post = 0.2, Total = 6.27 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.089 0.005     -0.099   -0.089     -0.079 -0.089   0

Random effects:
  Name    Model
    id_area Besags ICAR model

Model hyperparameters:
                      mean   sd 0.025quant 0.5quant 0.975quant mode
Precision for id_area 4.30 0.26       3.81     4.29       4.83 4.27

Marginal log-Likelihood:  -8822.75 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>Aiming to plot the fitted values for the different spatio-temporal approaches, we will use the function <code>plot_rr_years()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>plot_rr_years <span class="ot">&lt;-</span> <span class="cf">function</span> (d, <span class="at">col_name =</span> <span class="st">"fitted.values"</span>, <span class="at">temporal_name =</span> <span class="st">"year"</span>, <span class="at">tt =</span> <span class="st">""</span>, ...) {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(d) <span class="sc">+</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> .data[[col_name]])) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> .data[[temporal_name]], <span class="at">dir =</span> <span class="st">"h"</span>, <span class="at">ncol =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">name =</span> <span class="st">"Relative risk"</span>, <span class="at">midpoint =</span> <span class="dv">1</span>, <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> tt) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    custom_theme <span class="sc">+</span> </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>data_3_1 <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>, <span class="st">"geometry"</span>)], <span class="at">fitted.values =</span> model_3_1<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_rr_years</span>(<span class="at">d =</span> data_3_1, <span class="at">tt =</span> <span class="st">"Replicates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="additive-model" class="level2">
<h2 class="anchored" data-anchor-id="additive-model">Additive model</h2>
<p>Alternatively, we can fit a model with an additive structure for random effects in space and time. For instance,</p>
<p><span class="math display">\begin{align*}
\log(\theta_{it}) = \alpha + u_i + \varrho_t,
\end{align*}</span> where <span class="math inline">u_i \sim \text{ICAR}</span> and, e.g., <span class="math inline">\varrho_t \sim \text{AR}(1)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>formula_2 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_time, <span class="at">model =</span> <span class="st">"rw1"</span>) <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"besag"</span>, <span class="at">graph =</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>model_3_2 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_2,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.82, Running = 0.609, Post = 0.0369, Total = 2.46 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.122 0.006     -0.132   -0.122     -0.111 -0.122   0

Random effects:
  Name    Model
    id_time RW1 model
   id_area Besags ICAR model

Model hyperparameters:
                        mean      sd 0.025quant 0.5quant 0.975quant   mode
Precision for id_time 534.89 181.071     262.98   507.25     967.07 456.29
Precision for id_area   5.85   0.964       4.16     5.78       7.95   5.66

Marginal log-Likelihood:  -6008.24 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>data_3_2 <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>, <span class="st">"geometry"</span>)], <span class="at">fitted.values =</span> model_3_2<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_rr_years</span>(<span class="at">d =</span> data_3_2, <span class="at">tt =</span> <span class="st">"Additive model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="kronecker-product-model" class="level2">
<h2 class="anchored" data-anchor-id="kronecker-product-model">Kronecker product model</h2>
<p>A more elaborated solution is to consider a spatio-temporal random effect. In particular, we will fit a grouped (or Kronecker) separable model. A more rigorous motivation for this approach is available <a href="https://github.com/hrue/r-inla/blob/devel/internal-doc/group/group-models.pdf">here</a>.</p>
<p>In a nutshell, in the grouped random effected,</p>
<ol type="1">
<li>There is a <strong>within</strong> group correlation structure, and</li>
<li>There is a <strong>between</strong> group correlation structure.</li>
</ol>
<p>In particular, if <span class="math inline">y_{g, i}</span> is the <span class="math inline">i</span>-the element in group <span class="math inline">g</span>, then <span class="math inline">\text{Cov}(y_{g_1, i_1}, y_{g_2, i_2}) = (\text{cov. between groups } g_1 \text{ and } g_2) \times (\text{cov. between elements } i_1 \text{ and } i_2)</span> (<a href="http://faculty.washington.edu/jonno/SISMIDmaterial/8-Groupedmodels.pdf">Simpson, 2016</a>).</p>
<p>In <code>INLA</code>, the within-group effect is the one defined in the main <code>f()</code> function, while the between effect is the one defined using the <code>control.group</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>formula_3 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"besag"</span>, <span class="at">graph =</span> g, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">group =</span> id_time, <span class="at">control.group =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"rw1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model_3_3 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_3,</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.76, Running = 4.32, Post = 0.117, Total = 6.19 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.106 0.006     -0.117   -0.106     -0.095 -0.106   0

Random effects:
  Name    Model
    id_area Besags ICAR model

Model hyperparameters:
                       mean   sd 0.025quant 0.5quant 0.975quant  mode
Precision for id_area 17.37 1.93      13.92    17.25      21.46 17.03

Marginal log-Likelihood:  -9154.40 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>data_3_3 <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>, <span class="st">"geometry"</span>)], <span class="at">fitted.values =</span> model_3_3<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_rr_years</span>(<span class="at">d =</span> data_3_3, <span class="at">tt =</span> <span class="st">"Kronecker product model (grouped by </span><span class="sc">\"</span><span class="st">time</span><span class="sc">\"</span><span class="st">)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="bernardinelli-model" class="level2">
<h2 class="anchored" data-anchor-id="bernardinelli-model">Bernardinelli model</h2>
<p>Lastly, we can also implement the Bernardinelli model (<a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.4780142112">Bernardinelli et al., 1995</a>) using <code>INLA</code>. In this case, the linear predictor will be defined as follows</p>
<p><span class="math display">\begin{align*}
\log(\theta_{it}) = \alpha + u_i + v_i + (\beta + \delta_i) \times t_j,
\end{align*}</span> where <span class="math inline">u_i + v_i</span> is a <code>iid + besag</code> model, <span class="math inline">\beta</span> is the global linear trend, and <span class="math inline">\delta_i</span> denotes a space-time interaction; in particular, this model allows each of the areas to have its own time trend with spatial intercept given by <span class="math inline">(\alpha + u_i + v_i)</span> and slope given by <span class="math inline">(\beta + \delta_i)</span> (<a href="https://www.paulamoraga.com/book-geospatial/sec-arealdatatheory.html#spatio-temporal-small-area-disease-risk-estimation">Moraga, 2019</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>formula_4 <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id_area, <span class="at">model =</span> <span class="st">"bym"</span>, <span class="at">graph =</span> g) <span class="sc">+</span> <span class="fu">f</span>(id_area_cp, id_time, <span class="at">model =</span> <span class="st">"iid"</span>) <span class="sc">+</span> id_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>model_3_4 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_4,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data, </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> E,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.88, Running = 0.631, Post = 0.0372, Total = 2.55 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.528 0.021     -0.570   -0.528     -0.487 -0.528   0
id_time      0.037 0.001      0.035    0.037      0.039  0.037   0

Random effects:
  Name    Model
    id_area BYM model
   id_area_cp IID model

Model hyperparameters:
                                              mean       sd 0.025quant 0.5quant
Precision for id_area (iid component)        34.24     8.45      20.12    33.40
Precision for id_area (spatial component)    91.53   102.38      13.76    61.33
Precision for id_area_cp                  49251.00 17455.34   24120.92 46259.24
                                          0.975quant     mode
Precision for id_area (iid component)          53.16    31.96
Precision for id_area (spatial component)     358.12    31.78
Precision for id_area_cp                    91906.40 40773.85

Marginal log-Likelihood:  -5938.96 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>data_3_4 <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data[, <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>, <span class="st">"geometry"</span>)], <span class="at">fitted.values =</span> model_3_4<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_rr_years</span>(<span class="at">d =</span> data_3_4, <span class="at">tt =</span> <span class="st">"Bernardinelli model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="geostatistical-data" class="level1">
<h1>Geostatistical data</h1>
<p>Throughout this section, we will assume that <span class="math display">\begin{align*}
    y_i = \mu + \zeta(x_i) + \varepsilon_i, ~\forall i,
\end{align*}</span> where <span class="math inline">y = (y_1, \cdots, y_n)</span> are the observations at <span class="math inline">x = (x_1, \cdots, x_n)</span>, <span class="math inline">\mu</span> is the common mean, <span class="math inline">\zeta(x)</span> is a zero-mean stationary and isotropic Gaussian random field, and <span class="math inline">\varepsilon \overset{\text{i.i.d.}}{\sim}\text{Normal}(0, \sigma^2_{\varepsilon})</span>. In particular, <span class="math inline">\zeta(x)</span> has a <a href="https://becarioprecario.bitbucket.io/spde-gitbook/ch-intro.html#sec:matern">Matérn structure</a>.</p>
<p>Other more sophisticated models are described in <a href="https://becarioprecario.bitbucket.io/spde-gitbook/index.html">Advanced Spatial Modeling with Stochastic Partial Differential Equations Using R and INLA</a> (<a href="https://becarioprecario.bitbucket.io/spde-gitbook/index.html">Krainski et al., 2019</a>).</p>
<p>For fitting such a model, we can rely on a stochastic partial differential equation (SPDE) approach. As showed in <a href=".">Whittle</a> (<a href=".">1963</a>), a Gaussian random field with Matérn covariance structure can be expressed as a solution of the following SPDE <span class="math display">\begin{align*}
    (\kappa^2 - \Delta)^{\alpha/2}(\tau S(x)) = \mathcal{W}(x),
\end{align*}</span> where <span class="math inline">\Delta</span> is the Laplacian, <span class="math inline">\mathcal{W}(s)</span> is a Gaussian white-noise random process, <span class="math inline">\alpha</span> controls the smoothness of the random field, <span class="math inline">\tau</span> controls the variance, and <span class="math inline">\kappa</span> is a scale parameter.</p>
<p>Based on this result, <a href="https://academic.oup.com/jrsssb/article/73/4/423/7034732">Lindgren et al.</a> (<a href="https://academic.oup.com/jrsssb/article/73/4/423/7034732">2011</a>) proposed a new procedure for representing a Gaussian random field with Matérn covariance as a Gaussian Markov Random Field (GMRF). They did this by expressing a solution of the SPDE using the Finite Element Method (FEM).</p>
<p>As in <a href="https://www.paulamoraga.com/book-geospatial/sec-geostatisticaldatatheory.html#stochastic-partial-differential-equation-approach">Moraga (2019)</a>,</p>
<blockquote class="blockquote">
<p>An approximate solution of the SPDE can be found by using the Finite Element method. This method divides the spatial domain into a set of non-intersecting triangles leading to a triangulated mesh with <span class="math inline">n</span> nodes and <span class="math inline">n</span> basis functions. Basis functions <span class="math inline">\{\phi_k(x)\}_{k = 1}^{n}</span> are defined as piecewise linear functions on each triangle that is equal to <span class="math inline">1</span> at vertex <span class="math inline">k</span>, and equal to <span class="math inline">0</span> at the other vertices. Then, the continuously indexed Gaussian field <span class="math inline">\zeta</span> is represented as a discretely indexed Gaussian Markov random field (GMRF) by means of the finite basis functions defined on the triangulated mesh <span class="math display">\zeta(x) = \sum_{k = 1}^{n} \beta_k \phi_k(x),</span> where <span class="math inline">n</span> is the number of vertices of the triangulation, <span class="math inline">\{\phi_k(x)\}_{k = 1}^{n}</span> denotes the piecewise linear basis functions, and <span class="math inline">\{\beta_k\}_{k = 1}^{n}</span> are zero-mean Gaussian distributed weights.</p>
</blockquote>
<hr>
<p>The smoothness parameter <span class="math inline">\nu</span> of the Matérn covariance structure is related to <span class="math inline">\alpha</span> in the SPDE formulation through <span class="math inline">\alpha = \nu + (d / 2)</span>, where <span class="math inline">d</span> (typically <span class="math inline">d = 2</span>) is dimension. In <code>INLA</code>, <span class="math inline">0 \leq \alpha &lt; 2</span>.</p>
<section id="pm2.5" class="level2">
<h2 class="anchored" data-anchor-id="pm2.5">PM2.5</h2>
<p>We will analyze the particulate matter 2.5 (PM2.5), measured in <span class="math inline">\mu \text{g} / \text{m}^3)</span> levels in the United States (USA) in 2022. The data is the same as the one analyzed in <a href="https://link.springer.com/article/10.1007/s13253-023-00571-0">Amaral et al.</a> (<a href="https://link.springer.com/article/10.1007/s13253-023-00571-0">2023</a>). The data can be downloaded from <a href="https://github.com/avramaral/INLA_tutorial/raw/main/data/example_4/example_4_data.zip">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>data_USA <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/example_4/data_USA.rds"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>USA <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/example_4/USA_filtered.rds"</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_USA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 415.5262 ymin: 3374.241 xmax: 611.4046 ymax: 3794.633
Projected CRS: +init=epsg:6345 +units=km +no_defs
# A tibble: 6 × 3
   mean    sd            geometry
  &lt;dbl&gt; &lt;dbl&gt;        &lt;POINT [km]&gt;
1  7.95  4.52 (415.5262 3374.241)
2  7.3   3.96 (611.4046 3683.513)
3  7.24  3.70 (594.8104 3794.633)
4  8.66  4.20  (593.0379 3761.67)
5  9.75  5.28 (517.1733 3712.617)
6  8.44  3.39 (499.6639 3687.995)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> USA, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_USA, <span class="fu">aes</span>(<span class="at">fill =</span> mean), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">"PM2.5 level"</span>, <span class="at">colors =</span> pal) <span class="sc">+</span> </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, let us pre-process the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Boundary coordinates</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>USA_coor <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(USA)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>USA_coor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(USA_coor[, <span class="dv">1</span>], USA_coor[, <span class="dv">2</span>]), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(USA_coor) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(USA_coor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           lon      lat
[1,] -91.01918 5501.724
[2,] -90.93677 5501.492
[3,] -90.68302 5501.466
[4,] -90.57107 5501.223
[5,] -90.35477 5501.060
[6,] -90.34765 5501.055</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Points coordinates</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>data_coor <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(data_USA)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>data_USA  <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data_USA, <span class="fu">as_tibble</span>(data_coor))</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>data_USA  <span class="ot">&lt;-</span> data_USA <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">lon =</span> X, <span class="at">lat =</span> Y) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(mean, sd, lon, lat, geometry)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_USA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 4 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 415.5262 ymin: 3374.241 xmax: 611.4046 ymax: 3794.633
Projected CRS: +init=epsg:6345 +units=km +no_defs
# A tibble: 6 × 5
   mean    sd   lon   lat            geometry
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;        &lt;POINT [km]&gt;
1  7.95  4.52  416. 3374. (415.5262 3374.241)
2  7.3   3.96  611. 3684. (611.4046 3683.513)
3  7.24  3.70  595. 3795. (594.8104 3794.633)
4  8.66  4.20  593. 3762.  (593.0379 3761.67)
5  9.75  5.28  517. 3713. (517.1733 3712.617)
6  8.44  3.39  500. 3688. (499.6639 3687.995)</code></pre>
</div>
</div>
<p>And create the mesh with the <code>inla.mesh.2d()</code> function. A tool for mesh assessment is described <a href="https://becarioprecario.bitbucket.io/spde-gitbook/ch-intro.html#sec:toolsmesh">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># `max.edge`: the largest allowed triangle edge length. One or two values.</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `offset`: the automatic extension distance. One or two values, for an inner and an optional outer extension.</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(<span class="at">loc.domain =</span> USA_coor, <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">3000</span>), <span class="at">offset =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">1500</span>))</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>mesh<span class="sc">$</span>n <span class="co"># Number of nodes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 680</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot `mesh`</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mesh)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(USA<span class="sc">$</span>geometry, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">border =</span> <span class="st">"red"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(data_USA<span class="sc">$</span>lon, data_USA<span class="sc">$</span>lat, <span class="at">pch =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"green"</span>)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can build the SPDE model using one of the following functions: <code>inla.spde2.matern()</code> or <code>inla.spde2.pcmatern</code>. Notice that the parameterization of these two models is different, such that the latter accepts PC priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Building the SPDE model</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha = nu + d / 2 = 1 + 1 = 2, for nu = 1</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Flexible parameterization (with a default one)</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co"># spde &lt;- inla.spde2.matern(mesh = mesh, alpha = 2)</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameterization for PC priors</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh, </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="fl">1e3</span>, <span class="fl">0.90</span>), <span class="co"># P(range &lt; 1e3) = 0.90</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.01</span>)) <span class="co"># P(sigma &gt; 1.0) = 0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can create an <code>indxs</code> object for the SPDE model, as well as the projection matrix. The projection matrix depends on the <code>mesh</code> and <code>data_coor</code> and is used to project the Gaussian random field (GRF) from the observations to the triangulation vertices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Indices</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>indxs <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="st">"s"</span>, spde<span class="sc">$</span>n.spde)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Projection matrix</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> data_coor)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 928 680</code></pre>
</div>
</div>
<p>To make prediction, we have to define the set of coordinates where we want to estimate the process. Given location boundaries and the desired resolution, the function <code>create_prediction_grid()</code> does the job.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>create_prediction_grid <span class="ot">&lt;-</span> <span class="cf">function</span> (loc, <span class="at">resolution =</span> <span class="dv">25</span>, ...) {</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  pts_bdy <span class="ot">&lt;-</span> loc<span class="sc">$</span>geometry[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  pts_bdy_x <span class="ot">&lt;-</span> <span class="fu">range</span>(pts_bdy[, <span class="dv">1</span>])</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  pts_bdy_y <span class="ot">&lt;-</span> <span class="fu">range</span>(pts_bdy[, <span class="dv">2</span>])</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  coord_pred <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(pts_bdy_x[<span class="dv">1</span>], pts_bdy_x[<span class="dv">2</span>], <span class="at">by =</span> resolution), <span class="at">y =</span> <span class="fu">seq</span>(pts_bdy_y[<span class="dv">1</span>], pts_bdy_y[<span class="dv">2</span>], <span class="at">by =</span> resolution))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(coord_pred) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">st_as_sf</span>(coord_pred), <span class="st">"sf"</span>);   <span class="fu">st_crs</span>(xx) <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(loc<span class="sc">$</span>geometry)</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  yy <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">st_as_sf</span>(loc<span class="sc">$</span>geometry), <span class="st">"sf"</span>); <span class="fu">st_crs</span>(yy) <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(loc<span class="sc">$</span>geometry)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute intersection between grid and `loc` borders</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  pppts <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="at">x =</span> xx, <span class="at">y =</span> yy)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  coord_pred <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(pppts<span class="sc">$</span>geometry), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(coord_pred) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (p <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pppts<span class="sc">$</span>geometry)) { coord_pred[p, ] <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(pppts<span class="sc">$</span>geometry[[p]]) }</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  coord_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> coord_pred[, <span class="dv">1</span>], <span class="at">y =</span> coord_pred[, <span class="dv">2</span>])</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(coord_pred)</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>coord_pred <span class="ot">&lt;-</span> <span class="fu">create_prediction_grid</span>(USA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  coord_pred_cp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(coord_pred)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(coord_pred_cp) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(coord_pred_cp)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Similar to before, we must create a projection matrix for the locations where we want to make prediction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Projection matrix for prediction</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>Ap <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coord_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we can organize the data in stacks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stacks</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack for estimation </span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>stk_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est"</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> data_USA<span class="sc">$</span>mean),</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A),</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">b0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data_USA))), <span class="at">s =</span> indxs))</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack for prediction</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>stk_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred"</span>,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="cn">NA</span>),</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, Ap),</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">b0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(coord_pred))), <span class="at">s =</span> indxs))</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Full stack</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>stk_full <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_e, stk_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After all these steps, we can finally fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> b0 <span class="sc">+</span> <span class="fu">f</span>(s, <span class="at">model =</span> spde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>model_4_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"gaussian"</span>, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full), </span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk_full))) <span class="co"># Matrix of predictors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_4_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.36, Running = 1.89, Post = 0.118, Total = 4.37 
Fixed effects:
    mean    sd 0.025quant 0.5quant 0.975quant  mode kld
b0 6.818 0.304      6.208    6.821      7.414 6.821   0

Random effects:
  Name    Model
    s SPDE2 model

Model hyperparameters:
                                           mean     sd 0.025quant 0.5quant
Precision for the Gaussian observations   0.592  0.032      0.531    0.591
Range for s                             492.618 86.960    345.990  484.328
Stdev for s                               1.680  0.136      1.428    1.675
                                        0.975quant   mode
Precision for the Gaussian observations      0.656   0.59
Range for s                                687.299 466.93
Stdev for s                                  1.964   1.67

Marginal log-Likelihood:  -1721.00 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>As we did in the “Multiple linear regression” example, we can work with the posterior marginals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">inla.tmarginal</span>(<span class="at">fun =</span> <span class="cf">function</span>(x) { <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(x) }, <span class="at">marginal =</span> model_4_1<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">Precision for the Gaussian observations</span><span class="st">`</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(ss))) <span class="sc">+</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of the standard deviation for the observations"</span>) <span class="sc">+</span> </span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-90-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(model_4_1<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">Range for s</span><span class="st">`</span>))) <span class="sc">+</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of the range in the Matérn model"</span>) <span class="sc">+</span> </span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-90-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(model_4_1<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">Stdev for s</span><span class="st">`</span>))) <span class="sc">+</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of the standard deviation in the Matérn model"</span>) <span class="sc">+</span> </span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-90-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Remark:</strong> According to <a href="https://becarioprecario.bitbucket.io/spde-gitbook/ch-intro.html#sec:matern">this parameterization</a>, the scale parameter <span class="math inline">\kappa &gt; 0</span> can be expressed by <span class="math inline">\frac{\sqrt{8\nu}}{\text{range}}</span>, where <span class="math inline">\nu</span> is the smoothness parameter.</p>
<section id="prediction" class="level3">
<h3 class="anchored" data-anchor-id="prediction">Prediction</h3>
<p>Now, let us retrieve the predicted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted values and prediction</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Indices for the predicted observations</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>idxs_pred <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full, <span class="at">tag =</span> <span class="st">"pred"</span>)<span class="sc">$</span>data</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>pred_mm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_4_1<span class="sc">$</span>summary.fitted.values[idxs_pred, <span class="st">"mean"</span>]))</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>pred_ll <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_4_1<span class="sc">$</span>summary.fitted.values[idxs_pred, <span class="st">"0.025quant"</span>]))</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>pred_uu <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_4_1<span class="sc">$</span>summary.fitted.values[idxs_pred, <span class="st">"0.975quant"</span>]))</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a><span class="co"># E.g.,</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>pred_mm <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">posterior_mean =</span> V3) <span class="sc">%&gt;%</span> <span class="fu">head</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      x     y posterior_mean
  &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;
1 1026. 2733.           7.02
2 1051. 2733.           7.00
3 1076. 2733.           6.96
4 1076. 2758.           7.01
5 1126. 2758.           6.97
6 1101. 2783.           7.00</code></pre>
</div>
</div>
<p>To plot the posterior mean and percentiles, we will use the function <code>plot_pred_USA()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>plot_pred_USA <span class="ot">&lt;-</span> <span class="cf">function</span> (fitted_values, USA, r, <span class="at">tt =</span> <span class="st">""</span>, <span class="at">should_round =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(fitted_values) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gridded</span>(fitted_values) <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  fitted_values <span class="ot">&lt;-</span> <span class="fu">raster</span>(fitted_values)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crs</span>(fitted_values) <span class="ot">&lt;-</span> <span class="st">"+init=epsg:6345 +units=km +no_defs"</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  fitted_values    <span class="ot">&lt;-</span> <span class="fu">as</span>(fitted_values, <span class="st">"SpatialPixelsDataFrame"</span>)</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  fitted_values_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fitted_values)</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(fitted_values_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pred"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (should_round) {</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">floor</span>(r[<span class="dv">1</span>]), <span class="fu">ceiling</span>(r[<span class="dv">2</span>]), <span class="at">length.out =</span> <span class="dv">5</span>)</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(r[<span class="dv">1</span>], r[<span class="dv">2</span>], <span class="at">length.out =</span> <span class="dv">5</span>)</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#00008FFF"</span>, <span class="st">"#0000F2FF"</span>, <span class="st">"#0063FFFF"</span>, <span class="st">"#00D4FFFF"</span>, <span class="st">"#46FFB8FF"</span>, <span class="st">"#B8FF46FF"</span>, <span class="st">"#FFD400FF"</span>, <span class="st">"#FF6300FF"</span>, <span class="st">"#F00000FF"</span>, <span class="st">"#800000FF"</span>)</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>  pp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">data =</span> fitted_values_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> pred)) <span class="sc">+</span> </span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> USA, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">"PM2.5"</span>, <span class="at">colors =</span> pal, <span class="at">breaks =</span> breaks, <span class="at">limits =</span> <span class="fu">c</span>(breaks[<span class="dv">1</span>], <span class="fu">tail</span>(breaks, <span class="dv">1</span>))) <span class="sc">+</span> </span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> tt) <span class="sc">+</span> </span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>    custom_theme <span class="sc">+</span> </span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>  pp</span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>patchwork</code> package allows us to combine plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>pp_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>pp_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>pp_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>)</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>(pp_ll <span class="sc">+</span> pp_mm <span class="sc">+</span> pp_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-93-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="point-processes" class="level1">
<h1>Point processes</h1>
<p>In this section, we will see how to model a log-Gaussian Cox process (LGCP) using <code>INLA</code>. However, one can refer to <a href="https://avramaral.github.io/PP_inference/">this tutorial</a> for a more detailed explanation on how to make inference in point processes (also using <code>INLA</code>).</p>
<p>Recall that</p>
<blockquote class="blockquote">
<p>A Cox process can be seen as a doubly stochastic process. <span class="math inline">\xi</span> is a Cox process driven by <span class="math inline">\Lambda(x)</span> if</p>
<ol type="1">
<li><p><span class="math inline">\{\Lambda(x); x \in \mathcal{D}\}</span> is a non-negative valued stochastic process.</p></li>
<li><p>Conditional on <span class="math inline">\{\Lambda(x) = \lambda(x); \mathbf{x} \in \mathcal{D}\}</span>, <span class="math inline">\xi</span> is a Poisson process with intensity function <span class="math inline">\lambda(x)</span>.</p></li>
</ol>
</blockquote>
<p>A particular case of a Cox process, named <strong>log-Gaussian Cox process</strong>, can be constructed by setting <span class="math inline">\log(\Lambda(x)) = \mu^{\star}(x) + \zeta(x)</span>, such that <span class="math inline">\mu(x) = \exp(\mu^{\star}(x))</span> is possibly interpreted as the mean structure of <span class="math inline">\Lambda(x)</span>, and <span class="math inline">\zeta(x)</span> is a stationary Gaussian process, such that <span class="math inline">\mathbb{E}(\zeta(x)) = -\sigma^2/2</span>, <span class="math inline">\forall x</span>, and <span class="math inline">\text{Cov}(\zeta(x_1), \zeta(x_2)) = \phi(h) = \sigma^2 \rho(h)</span>, where <span class="math inline">h</span> is the distance between <span class="math inline">x_1</span> and <span class="math inline">x_2</span>, and <span class="math inline">\sigma^2</span> is the variance of <span class="math inline">\zeta(x)</span>.</p>
<hr>
<p>As we can see <a href="https://avramaral.github.io/PP_inference/#fitting-a-lgcp-with-r-inla">here</a>, a way to fit a LGCP with <code>INLA</code> is placing a regular grid, given by cells <span class="math inline">\{c_{ij}\}_{ij}</span>, on top of the spatial domain, such that <span class="math inline">\int_{c_{i,j}}\Lambda(x)dx \approx |c_{i,j}|\Lambda(x)</span>, where <span class="math inline">|\cdot|</span> denotes the area.</p>
<p>Thus, conditional on <span class="math inline">\zeta(x)</span>, the number of locations in the grid cell <span class="math inline">c_{ij}</span>, <span class="math inline">\forall i, j</span>, are independent and Poisson distributed, such that <span class="math display">\begin{align*}
\mathcal{N}(c_{ij})|\zeta(x) &amp;\sim \text{Poisson}(|c_{ij}| \Lambda(x_{ij})), \forall i, j, \\
\log(\Lambda(x_{ij})) &amp;= \alpha + \cdots + \zeta(x_{ij})
\end{align*}</span> where <span class="math inline">\zeta(x)</span> is a Gaussian field (e.g., <code>matern2d</code>).</p>
<p>However, <a href="https://arxiv.org/abs/1111.0641">Simpson et al.</a>(<a href="https://arxiv.org/abs/1111.0641">2016</a>) proposed a method to make inference on LGCP while still considering the exact observation locations—instead of aggregating them over a regular grid and fitting a counting model for each cell.</p>
<p>The main idea consists of an approximation of the likelihood by fitting a Poisson model on an augmented data set made of the observation locations and integration points from the corresponding SPDE mesh (<code>1</code> for the observed points and <code>0</code> for the dummy variables, such that all have associated “expected values” <code>e</code>). The expected number of events in the integration points is defined to be proportional to the area around the node (the areas of the polygons in the dual mesh)</p>
<p><strong>Remark:</strong> The main reference for this section (and the next one) is <a href="https://becarioprecario.bitbucket.io/spde-gitbook/ch-lcox.html">Chapter 4: Point processes and preferential sampling</a>.</p>
<section id="pm2.5-stations" class="level2">
<h2 class="anchored" data-anchor-id="pm2.5-stations">PM2.5 stations</h2>
<p>Although the problem of estimating PM2.5 depends, obviously, on the observed pollution levels, we will ignore it for now and focus on the sampling process, i.e., the locations where the monitoring stations were placed and treat them as a realization of a random process. In particular, a LGCP.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_USA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 4 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 415.5262 ymin: 3374.241 xmax: 611.4046 ymax: 3794.633
Projected CRS: +init=epsg:6345 +units=km +no_defs
# A tibble: 6 × 5
   mean    sd   lon   lat            geometry
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;        &lt;POINT [km]&gt;
1  7.95  4.52  416. 3374. (415.5262 3374.241)
2  7.3   3.96  611. 3684. (611.4046 3683.513)
3  7.24  3.70  595. 3795. (594.8104 3794.633)
4  8.66  4.20  593. 3762.  (593.0379 3761.67)
5  9.75  5.28  517. 3713. (517.1733 3712.617)
6  8.44  3.39  500. 3688. (499.6639 3687.995)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> USA, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_USA, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-94-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We will also use the data pre-processed in the previous section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_coor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            X        Y
[1,] 415.5262 3374.241
[2,] 611.4046 3683.513
[3,] 594.8104 3794.633
[4,] 593.0379 3761.670
[5,] 517.1733 3712.617
[6,] 499.6639 3687.995</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(USA_coor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           lon      lat
[1,] -91.01918 5501.724
[2,] -90.93677 5501.492
[3,] -90.68302 5501.466
[4,] -90.57107 5501.223
[5,] -90.35477 5501.060
[6,] -90.34765 5501.055</code></pre>
</div>
</div>
<p>Let us start with the mesh and the SPDE model. For the former, we will use the same object (<code>mesh</code>) we created for the previous section, for the latter, we may want to use different priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-96-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh, </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="fl">1e3</span>, <span class="fl">0.90</span>), <span class="co"># P(range &lt; 1e3) = 0.90</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.01</span>)) <span class="co"># P(sigma &gt; 1.0) = 0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then built the dual mesh using the function <code>inla.dual.mesh()</code> (extracted from <a href="https://becarioprecario.bitbucket.io/spde-gitbook/index.html">Advanced Spatial Modeling with Stochastic Partial Differential Equations Using R and INLA</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>inla.dual.mesh <span class="ot">&lt;-</span> <span class="cf">function</span> (mesh, ...) {</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mesh<span class="sc">$</span>manifold <span class="sc">==</span> <span class="st">"R2"</span>) {</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    ce <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mesh<span class="sc">$</span>graph<span class="sc">$</span>tv), <span class="cf">function</span> (i) { <span class="fu">colMeans</span>(mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[i, ], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) }))</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">"parallel"</span>)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    pls <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>mesh<span class="sc">$</span>n, <span class="cf">function</span> (i) {</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">Reduce</span>(<span class="st">"rbind"</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="cf">function</span> (k) {</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> <span class="fu">which</span>(mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[,k] <span class="sc">==</span> i)</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(j) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">rbind</span>(ce[j, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">cbind</span>(mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[j, k], <span class="dv">1</span>] <span class="sc">+</span> mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[j, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span>)[k]], <span class="dv">1</span>], </span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>                             mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[j, k], <span class="dv">2</span>] <span class="sc">+</span> mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>graph<span class="sc">$</span>tv[j, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span>)[k]], <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(ce[j, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>      })))</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>      j1 <span class="ot">&lt;-</span> <span class="fu">which</span>(mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[, <span class="dv">1</span>] <span class="sc">==</span> i)</span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>      j2 <span class="ot">&lt;-</span> <span class="fu">which</span>(mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[, <span class="dv">2</span>] <span class="sc">==</span> i)</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> ((<span class="fu">length</span>(j1) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|</span> (<span class="fu">length</span>(j2) <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>        p <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">rbind</span>(mesh<span class="sc">$</span>loc[i, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], p,</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>                          mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[j1, <span class="dv">1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[j1, <span class="dv">2</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span>, </span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>                          mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[j2, <span class="dv">1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> mesh<span class="sc">$</span>loc[mesh<span class="sc">$</span>segm<span class="sc">$</span>bnd<span class="sc">$</span>idx[j2, <span class="dv">2</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>        yy <span class="ot">&lt;-</span> p[, <span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(p[, <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> mesh<span class="sc">$</span>loc[i, <span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>        xx <span class="ot">&lt;-</span> p[, <span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(p[, <span class="dv">1</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> mesh<span class="sc">$</span>loc[i, <span class="dv">1</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>        yy <span class="ot">&lt;-</span> p[, <span class="dv">2</span>] <span class="sc">-</span> mesh<span class="sc">$</span>loc[i, <span class="dv">2</span>]</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>        xx <span class="ot">&lt;-</span> p[, <span class="dv">1</span>] <span class="sc">-</span> mesh<span class="sc">$</span>loc[i, <span class="dv">1</span>]</span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Polygon</span>(p[<span class="fu">order</span>(<span class="fu">atan2</span>(yy, xx)), ])</span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">SpatialPolygons</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>mesh<span class="sc">$</span>n, <span class="cf">function</span> (i) { <span class="fu">Polygons</span>(<span class="fu">list</span>(pls[[i]]), i)} )))</span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> { <span class="fu">stop</span>(<span class="st">"It only works for R2."</span>) }</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>dual_mesh <span class="ot">&lt;-</span> <span class="fu">inla.dual.mesh</span>(mesh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can compute the weights (<code>wgt</code>) based on the dual mesh, such that the regions outside of the location boundaries have weight <code>0</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>USA_poly <span class="ot">&lt;-</span> <span class="fu">SpatialPolygons</span>(<span class="fu">list</span>(<span class="fu">Polygons</span>(<span class="fu">list</span>(<span class="fu">Polygon</span>(USA_coor)), <span class="at">ID =</span> <span class="st">"1"</span>)))</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>wgt <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dual_mesh), <span class="cf">function</span> (i) {</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">gIntersects</span>(dual_mesh[i, ], USA_poly)) {</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">gArea</span>(<span class="fu">gIntersection</span>(dual_mesh[i, ], USA_poly)))</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(wgt, <span class="at">main =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-101-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting dual mesh color coded based on the `wgt`</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mesh<span class="sc">$</span>loc, <span class="at">asp =</span> <span class="dv">1</span>, <span class="at">col =</span> (wgt <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">axes =</span> F, <span class="at">cex =</span> <span class="fl">0.6</span>) </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mesh, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(dual_mesh, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(USA<span class="sc">$</span>geometry, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">border =</span> <span class="st">"green"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-101-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As before, we must construct the projection matrices and format the data in the “right” way (i.e., in stacks). For prediction, we use assume the same <code>coord_pred</code> as in the previous section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coord_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            x       y
[1,] 1025.571 2732.56
[2,] 1050.571 2732.56
[3,] 1075.571 2732.56
[4,] 1075.571 2757.56
[5,] 1125.571 2757.56
[6,] 1100.571 2782.56</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>n_vtx <span class="ot">&lt;-</span> mesh<span class="sc">$</span>n</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>n_pts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_USA)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>n_pts_pred <span class="ot">&lt;-</span> <span class="fu">nrow</span>(coord_pred)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Indices</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>indxs <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="st">"s"</span>, spde<span class="sc">$</span>n.spde)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a><span class="co"># augmented data: `0` for the mesh nodes and `1` for the observations</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>y_pp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="fu">c</span>(n_vtx, n_pts))</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposure vector</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>e_pp <span class="ot">&lt;-</span> <span class="fu">c</span>(wgt, <span class="fu">rep</span>(<span class="dv">0</span>, n_pts)) </span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Projection matrix (in two parts)</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) For the integration points, this is just a diagonal matrix--as these locations are just the mesh vertices</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>imat <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(n_vtx, <span class="fu">rep</span>(<span class="dv">1</span>, n_vtx))</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) For the observed points, the projection matrix is defined with `inla.spde.make.A`</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>ymat <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(mesh, data_coor)</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) + (2)</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>A_pp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(imat, ymat)</span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>A_pp_p <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coord_pred) <span class="co"># Projection matrix for the prediction points</span></span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stacks</span></span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack for estimation </span></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>stk_pp_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est_pp"</span>,</span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> y_pp, <span class="at">e =</span> e_pp),</span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp),</span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">alpha_pp =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_vtx <span class="sc">+</span> n_pts), <span class="at">s =</span> indxs))</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>stk_pp_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred_pp"</span>,</span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred), <span class="at">e =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred)),</span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp_p),</span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">alpha_pp =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred), <span class="at">s =</span> indxs))</span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Full stack</span></span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>stk_full_pp <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_pp_e, stk_pp_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us fit the model. Note that we are using a Poisson likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> alpha_pp <span class="sc">+</span> <span class="fu">f</span>(s, <span class="at">model =</span> spde)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>model_5_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="st">"poisson"</span>, </span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> <span class="fu">inla.stack.data</span>(stk_full_pp)<span class="sc">$</span>e,</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full_pp), </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">link =</span> <span class="dv">1</span>,</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk_full_pp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_5_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.66, Running = 2.41, Post = 0.15, Total = 5.21 
Fixed effects:
           mean    sd 0.025quant 0.5quant 0.975quant   mode kld
alpha_pp -9.187 0.334     -9.811   -9.202     -8.476 -9.251   0

Random effects:
  Name    Model
    s SPDE2 model

Model hyperparameters:
                mean      sd 0.025quant 0.5quant 0.975quant     mode
Range for s 1217.356 305.964    749.947 1173.118    1945.13 1079.317
Stdev for s    0.937   0.147      0.692    0.922       1.27    0.886

Marginal log-Likelihood:  -9117.83 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<section id="prediction-1" class="level3">
<h3 class="anchored" data-anchor-id="prediction-1">Prediction</h3>
<p>Now, let us retrieve the predicted values for the intensity function and plot them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>idx_pp <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full_pp, <span class="at">tag =</span> <span class="st">"pred_pp"</span>)<span class="sc">$</span>data</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>pred_pp_mm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_5_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"mean"</span>]))</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>pred_pp_ll <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_5_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.025quant"</span>]))</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>pred_pp_uu <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_5_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.975quant"</span>]))</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected number of observations</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pred_pp_mm<span class="sc">$</span>V3 <span class="sc">*</span> (<span class="dv">25</span> <span class="sc">**</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 923.9056</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_pp_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_pp_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_pp_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>pp_pp_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>,   <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>pp_pp_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>,  <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>pp_pp_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>, <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>(pp_pp_ll <span class="sc">+</span> pp_pp_mm <span class="sc">+</span> pp_pp_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-106-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="preferential-sampling-ps" class="level1">
<h1>Preferential sampling (PS)</h1>
<p>At this point, we can implement a more sophisticated model for PM2.5. We will assume that the sampling process (modeled in the previous section) is <strong>not</strong> independent of the latent field. In our problem, this is equivalent to stating that the locations where the monitoring stations were placed are somehow influenced by the pollution levels at those sites. This is known as <strong>preferential sampling</strong> (<a href="https://doi.org/10.1111/j.1467-9876.2009.00701.x">Diggle et al., 2010</a>).</p>
<p>Formally, <span class="math display">\begin{align*}
    y_i &amp;= \mu + \zeta(x_i) + \varepsilon_i, ~\forall i, \\
    \xi|\zeta(x) &amp;\sim \text{PPP}(\Lambda(x)) \\  
    \log(\Lambda(x)) &amp;= \alpha + \cdots + \gamma \cdot \zeta(x)
\end{align*}</span> where <span class="math inline">\gamma \in \mathbb{R}</span> is the “degree of preferentiality”, and all other quantities are defined as before.</p>
<p>In <code>INLA</code> we can fit this model using multiple likelihoods and <code>copy</code> of the random effects.</p>
<section id="pm2.5-1" class="level2">
<h2 class="anchored" data-anchor-id="pm2.5-1">PM2.5</h2>
<p>To fit the model, we will re-use many objects we already defined in previous sections.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following objects will be re-used</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `data_USA` </span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `USA`</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `data_coor`</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># `USA_coor`</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="co"># `mesh`</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="co"># `dual_mesh`</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="co"># `wgt`</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="co"># `coord_pred`</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> USA, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_USA, <span class="fu">aes</span>(<span class="at">fill =</span> mean), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">"PM2.5 level"</span>, <span class="at">colors =</span> pal) <span class="sc">+</span> </span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-107-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the SPDE model may have different priors, we will define it again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh, </span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="fl">1e3</span>, <span class="fl">0.90</span>), <span class="co"># P(range &lt; 1e3) = 0.90</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.01</span>)) <span class="co"># P(sigma &gt; 1.0) = 0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similar to before, let us construct the projection matrices and format the data into stacks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>n_vtx <span class="ot">&lt;-</span> mesh<span class="sc">$</span>n</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>n_pts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_USA)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>n_pts_pred <span class="ot">&lt;-</span> <span class="fu">nrow</span>(coord_pred)</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>indxs <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="st">"s"</span>, spde<span class="sc">$</span>n.spde)</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>indxv <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="st">"v"</span>, spde<span class="sc">$</span>n.spde)</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>y_pp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="fu">c</span>(n_vtx, n_pts))</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>e_pp <span class="ot">&lt;-</span> <span class="fu">c</span>(wgt, <span class="fu">rep</span>(<span class="dv">0</span>, n_pts)) </span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>imat <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(n_vtx, <span class="fu">rep</span>(<span class="dv">1</span>, n_vtx))</span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>ymat <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(mesh, data_coor)</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>A_pp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(imat, ymat)</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>A_pp_p <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coord_pred) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The stacks will have two columns for the <code>data</code> component, one for each likelihood. Besides, notice that we have stacks for the <code>gaussian</code> component (<code>stk_y_X</code>) and for the <code>poisson</code> component (<code>stk_pp_X</code>)—both for estimation and prediction. At the end, all of them are combined into one object (<code>stk_full_pp_y</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stacks</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `data` has two columns, one for each likelihood</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>stk_y_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est_y"</span>,</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(data_USA<span class="sc">$</span>mean, <span class="cn">NA</span>), <span class="at">e =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts)),</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, ymat),</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts), <span class="at">s =</span> indxs)) </span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>stk_y_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred_y"</span>,</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred), <span class="cn">NA</span>), <span class="at">e =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred)),</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp_p),</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred), <span class="at">s =</span> indxs)) </span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>stk_pp_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est_pp"</span>,</span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="cn">NA</span>, y_pp), <span class="at">e =</span> e_pp),</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp),</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">alpha_pp =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_vtx <span class="sc">+</span> n_pts), <span class="at">v =</span> indxv))</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>stk_pp_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred_pp"</span>,</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="cn">NA</span>, <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred)), <span class="at">e =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred)),</span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp_p),</span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">alpha_pp =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred), <span class="at">v =</span> indxv))</span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Full stack</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>stk_full_pp_y <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_y_e, stk_y_p, stk_pp_e, stk_pp_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let us fit the model.</p>
<p>To do so, notice that we are “copying” a random effect. The <code>copy</code> feature allows for the inclusion of a shared term among several linear predictors. Besides, we are assigning a <span class="math inline">\text{Normal}(0, 1)</span> prior for <span class="math inline">\gamma</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>re_prior <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"gaussian"</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `fixed = FALSE` allows the copy coefficient to be estimated</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> mu <span class="sc">+</span> alpha_pp <span class="sc">+</span> <span class="fu">f</span>(s, <span class="at">model =</span> spde) <span class="sc">+</span> <span class="fu">f</span>(v, <span class="at">copy =</span> <span class="st">"s"</span>, <span class="at">fixed =</span> <span class="cn">FALSE</span>, <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">beta =</span> re_prior))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>model_6_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="fu">c</span>(<span class="st">"gaussian"</span>, <span class="st">"poisson"</span>), </span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> <span class="fu">inla.stack.data</span>(stk_full_pp_y)<span class="sc">$</span>e,</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full_pp_y), </span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">link =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="fu">c</span>((n_pts <span class="sc">+</span> n_pts_pred), (n_vtx <span class="sc">+</span> n_pts <span class="sc">+</span> n_pts_pred))),</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk_full_pp_y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_6_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.63, Running = 5.76, Post = 0.508, Total = 8.9 
Fixed effects:
           mean    sd 0.025quant 0.5quant 0.975quant   mode kld
mu        6.653 0.378      5.927    6.643      7.442  6.645   0
alpha_pp -9.278 0.238     -9.736   -9.284     -8.778 -9.283   0

Random effects:
  Name    Model
    s SPDE2 model
   v Copy

Model hyperparameters:
                                           mean      sd 0.025quant 0.5quant
Precision for the Gaussian observations   0.409   0.026      0.360    0.409
Range for s                             971.868 293.364    548.388  922.273
Stdev for s                               1.302   0.206      0.955    1.283
Beta for v                                0.634   0.066      0.508    0.633
                                        0.975quant    mode
Precision for the Gaussian observations      0.462   0.408
Range for s                               1689.346 822.169
Stdev for s                                  1.764   1.238
Beta for v                                   0.766   0.629

Marginal log-Likelihood:  -10982.56 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="fu">inla.smarginal</span>(model_6_1<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">Beta for v</span><span class="st">`</span>))) <span class="sc">+</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Posterior of the degree of preferentiality (gamma)"</span>) <span class="sc">+</span> </span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  custom_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-114-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="prediction-2" class="level3">
<h3 class="anchored" data-anchor-id="prediction-2">Prediction</h3>
<p>Similar to before, we can finally retrieve the fitted values—both for the response and intensity processes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Response</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>idx_y  <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full_pp_y, <span class="at">tag =</span> <span class="st">"pred_y"</span> )<span class="sc">$</span>data</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>pred_y_mm  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"mean"</span>]))</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>pred_y_ll  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"0.025quant"</span>]))</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>pred_y_uu  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"0.975quant"</span>]))</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_y_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_y_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_y_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>pp_y_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>)</span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>pp_y_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>)</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>pp_y_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>)</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>(pp_y_ll <span class="sc">+</span> pp_y_mm <span class="sc">+</span> pp_y_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Intensity process</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>idx_pp <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full_pp_y, <span class="at">tag =</span> <span class="st">"pred_pp"</span>)<span class="sc">$</span>data</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>pred_pp_mm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"mean"</span>]))</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>pred_pp_ll <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.025quant"</span>]))</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>pred_pp_uu <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_6_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.975quant"</span>]))</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected number of observations</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pred_pp_mm<span class="sc">$</span>V3 <span class="sc">*</span> (<span class="dv">25</span> <span class="sc">**</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 903.7687</code></pre>
</div>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_pp_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_pp_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_pp_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>pp_pp_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>,   <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>pp_pp_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>,  <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>pp_pp_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>, <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>(pp_pp_ll <span class="sc">+</span> pp_pp_mm <span class="sc">+</span> pp_pp_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-115-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="one-more-thing-spat.-varying-ps" class="level1">
<h1>One more thing (Spat. varying PS)</h1>
<p>Expanding upon the PS model presented in the previous section, it may be desirable to enable the degree of preferentiality to vary across space. This could be especially beneficial when analyzing extensive regions, as the strength of dependence between the latent field and the sampling process is unlikely to remain constant across the spatial domain. This approach was originally proposed by <a href="https://doi.org/10.1007/s13253-023-00571-0">Amaral et al.</a> (<a href="https://doi.org/10.1007/s13253-023-00571-0">2023</a>) with code available <a href="https://github.com/avramaral/preferential_sampling/">here</a>.</p>
<p>In particular, <span class="math display">\begin{align*}
    y_i &amp;= \mu + \zeta(x_i) + \epsilon_i, \forall i \\
  \xi|\zeta(x) &amp;\sim \text{PPP}(\Lambda(x)) \\
  \log(\lambda(x)) &amp;= \alpha + \cdots + \gamma(x) \cdot \zeta(x) \\
  \gamma(x) &amp;= \sum_{k = 1}^{K}\beta_k \phi_k(x), \text{ s.t. } \beta_k \overset{\text{i.i.d.}}{\sim} \text{Normal}(0, \sigma^2_{\beta}), \forall k.
\end{align*}</span> From the above formulation, notice that <span class="math inline">\gamma(x)</span> is approximated by a combination of unknown coefficients <span class="math inline">\{\beta_k\}_k</span> and basis functions <span class="math inline">\{\phi_k(x)\}_k</span>. All remaining quantities are defined as before.</p>
<p>The type, number, and location of such basis functions are problem-dependent and <a href="https://doi.org/10.1007/s13253-023-00571-0">Amaral et al.</a> (<a href="https://doi.org/10.1007/s13253-023-00571-0">2023</a>) provide guidelines on how to set these aspects of the model.</p>
<p>For this tutorial, we will use “radial basis” built using a compactly supported Wendland (<a href="https://doi.org/10.1007/BF02123482">Wendland, 2015</a>) function defined in space.</p>
<blockquote class="blockquote">
<p>Radial Basis (Wendland): let <span class="math inline">h_k = \left(||x - a_k|| / b_k\right)</span>, such that <span class="math inline">b_k \in \mathbb{R}</span> and <span class="math inline">a_k \in \mathbb{R}^2</span>, <span class="math inline">\forall k</span>. Under this setting, <span class="math inline">a_k</span> is also known as a “node point,” and, sometimes, <span class="math inline">b_k</span> can also be referred to as “bandwidth.” Then, <span class="math display"> \phi_k(x) = \begin{cases} (1 - h_k)^6 (35h_k^2 + 18h_k + 3) / 3 &amp; h_k \in [0, 1] \\ 0   &amp; \text{otherwise.} \end{cases} </span></p>
</blockquote>
<section id="pm2.5-2" class="level2">
<h2 class="anchored" data-anchor-id="pm2.5-2">PM2.5</h2>
<p>Again, to fit the model, we will re-use objects we already defined in previous sections.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following objects will be re-used</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># `data_USA` </span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `USA`</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `data_coor`</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># `USA_coor`</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="co"># `mesh`</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="co"># `dual_mesh`</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co"># `wgt`</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="co"># `coord_pred`</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> USA, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_USA, <span class="fu">aes</span>(<span class="at">fill =</span> mean), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">"PM2.5 level"</span>, <span class="at">colors =</span> pal) <span class="sc">+</span> </span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  custom_theme <span class="sc">+</span> </span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-116-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the SPDE model may have different priors, we will define it again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh, </span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="fl">1e3</span>, <span class="fl">0.90</span>), <span class="co"># P(range &lt; 1e3) = 0.90</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.01</span>)) <span class="co"># P(sigma &gt; 1.0) = 0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step is to pre-compute the basis functions on the “mesh nodes + observed locations” for estimation and on the “prediction locations” for prediction. To do so, we will use the functions <code>basis_functions()</code> and <code>Wendland()</code>.</p>
<p><strong>Remark:</strong> user can define other smoothing kernels (e.g., <code>Wendland()</code>) and use them along with <code>basis_functions()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generic function</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>basis_functions <span class="ot">&lt;-</span> <span class="cf">function</span> (center_pts, loct, <span class="at">mesh =</span> <span class="cn">NULL</span>, bandwidth, <span class="at">smoothing_kernel =</span> <span class="st">"Wendland"</span>, ...) {</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(mesh)) {</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    all_pts <span class="ot">&lt;-</span> loct</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    all_pts <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mesh<span class="sc">$</span>loc[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], loct)</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">get</span>(smoothing_kernel)</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>  n_basis_functions <span class="ot">&lt;-</span> <span class="fu">nrow</span>(center_pts)</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_basis_functions) { b[[i]] <span class="ot">&lt;-</span> <span class="fu">f</span>(<span class="at">x =</span> all_pts[, <span class="dv">1</span>], <span class="at">y =</span> all_pts[, <span class="dv">2</span>], <span class="at">center_x =</span> center_pts[i, <span class="dv">1</span>], <span class="at">center_y =</span> center_pts[i, <span class="dv">2</span>], <span class="at">bandwidth =</span> bandwidth) }</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>  b</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Basis functions implementations (e.g., `Wendland`)</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>Wendland <span class="ot">&lt;-</span> <span class="cf">function</span> (x, y, center_x, center_y, <span class="at">bandwidth =</span> <span class="fl">0.5</span>, ...) {</span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">cbind</span>((x <span class="sc">-</span> center_x), (y <span class="sc">-</span> center_y))</span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> pts, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span> (x) { <span class="fu">sqrt</span>(<span class="fu">sum</span>(x <span class="sc">**</span> <span class="dv">2</span>)) }) <span class="sc">/</span> bandwidth</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> d) <span class="sc">^</span> <span class="dv">6</span> <span class="sc">*</span> (<span class="dv">35</span> <span class="sc">*</span> d <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">18</span> <span class="sc">*</span> d <span class="sc">+</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(d <span class="sc">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> k <span class="sc">/</span> <span class="fu">max</span>(k)</span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>  k</span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thus, for <code>bandwidth = 2500</code> and <code>center_pts</code> defined as below, we can pre-compute the basis functions for both estimation and prediction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>bandwidth <span class="ot">&lt;-</span> <span class="dv">2500</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>smoothing_kernel <span class="ot">&lt;-</span> <span class="st">"Wendland"</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>center_pts <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">2372</span>, <span class="dv">4346</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1984</span>, <span class="dv">5363</span>), <span class="fu">c</span>( <span class="sc">-</span><span class="dv">918</span>, <span class="dv">5143</span>),</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">c</span>( <span class="sc">-</span><span class="dv">518</span>, <span class="dv">3817</span>), <span class="fu">c</span>(  <span class="dv">263</span>, <span class="dv">4987</span>), <span class="fu">c</span>(  <span class="dv">677</span>, <span class="dv">4096</span>),</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">c</span>( <span class="dv">1494</span>, <span class="dv">4720</span>), <span class="fu">c</span>( <span class="sc">-</span><span class="dv">198</span>, <span class="dv">4291</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1710</span>, <span class="dv">4513</span>),</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">c</span>(  <span class="dv">875</span>, <span class="dv">3602</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1202</span>, <span class="dv">3742</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1310</span>, <span class="dv">4946</span>),</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">c</span>( <span class="sc">-</span><span class="dv">190</span>, <span class="dv">5189</span>), <span class="fu">c</span>(  <span class="dv">920</span>, <span class="dv">4550</span>), <span class="fu">c</span>( <span class="sc">-</span><span class="dv">233</span>, <span class="dv">4800</span>)))</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>bfs      <span class="ot">&lt;-</span> <span class="fu">basis_functions</span>(<span class="at">center_pts =</span> center_pts, <span class="at">loct =</span> data_coor,  <span class="at">mesh =</span> mesh, <span class="at">smoothing_kernel =</span> smoothing_kernel, <span class="at">bandwidth =</span> bandwidth)</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>bfs_pred <span class="ot">&lt;-</span> <span class="fu">basis_functions</span>(<span class="at">center_pts =</span> center_pts, <span class="at">loct =</span> coord_pred, <span class="at">mesh =</span> <span class="cn">NULL</span>, <span class="at">smoothing_kernel =</span> smoothing_kernel, <span class="at">bandwidth =</span> bandwidth)</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>pps <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(center_pts)) {</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>  pps[[i]] <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, bfs_pred[[i]])), <span class="at">USA =</span> USA, <span class="at">r =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">tt =</span> i)</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>((pps[[ <span class="dv">1</span>]] <span class="sc">+</span> pps[[ <span class="dv">2</span>]] <span class="sc">+</span> pps[[ <span class="dv">3</span>]]) <span class="sc">/</span> </span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a> (pps[[ <span class="dv">4</span>]] <span class="sc">+</span> pps[[ <span class="dv">5</span>]] <span class="sc">+</span> pps[[ <span class="dv">6</span>]]) <span class="sc">/</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a> (pps[[ <span class="dv">7</span>]] <span class="sc">+</span> pps[[ <span class="dv">8</span>]] <span class="sc">+</span> pps[[ <span class="dv">9</span>]]) <span class="sc">/</span> </span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a> (pps[[<span class="dv">10</span>]] <span class="sc">+</span> pps[[<span class="dv">11</span>]] <span class="sc">+</span> pps[[<span class="dv">12</span>]]) <span class="sc">/</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a> (pps[[<span class="dv">13</span>]] <span class="sc">+</span> pps[[<span class="dv">14</span>]] <span class="sc">+</span> pps[[<span class="dv">15</span>]])) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-119-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>One more time, let us construct the projection matrices and format the data into stacks.</p>
<p>Notice that projection matrices for all effects in the Poisson model are obtained by multiplying column-wise a base matrix by the vector of basis function evaluated at the corresponding locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>n_vtx <span class="ot">&lt;-</span> mesh<span class="sc">$</span>n</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>n_pts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_USA)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>n_pts_pred <span class="ot">&lt;-</span> <span class="fu">nrow</span>(coord_pred)</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>indx <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>spde<span class="sc">$</span>n.spde</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>y_pp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="fu">c</span>(n_vtx, n_pts))</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>e_pp <span class="ot">&lt;-</span> <span class="fu">c</span>(wgt, <span class="fu">rep</span>(<span class="dv">0</span>, n_pts)) </span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>imat <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(n_vtx, <span class="fu">rep</span>(<span class="dv">1</span>, n_vtx))</span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>ymat <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(mesh, data_coor)</span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>A_pp_base <span class="ot">&lt;-</span> <span class="fu">rbind</span>(imat, ymat)</span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>n_basis_functions <span class="ot">&lt;-</span> <span class="fu">nrow</span>(center_pts)</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>A_pp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_basis_functions) {</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>  A_pp[[i]] <span class="ot">&lt;-</span> A_pp_base <span class="sc">*</span> bfs[[i]] <span class="co"># Multiply each column by the basis function evaluated at the corresponding locations</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>A_pp_p_base <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> <span class="fu">as.matrix</span>(coord_pred))</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>A_pp_p <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_basis_functions) {</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>  A_pp_p[[i]] <span class="ot">&lt;-</span> A_pp_p_base <span class="sc">*</span> bfs_pred[[i]]</span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The stacks are defined similarly to before. However, for the Poisson model, it’s important to note that effects are built dynamically and reflect the number of basis functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stacks</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of effects based on the number of basis function</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>fx_effects <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">rep</span>(<span class="dv">1</span>, n_vtx <span class="sc">+</span> n_pts))</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>rd_effects <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(A_pp)) { rd_effects <span class="ot">&lt;-</span> <span class="fu">append</span>(rd_effects, <span class="fu">list</span>(indx)) } </span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>effects <span class="ot">&lt;-</span> <span class="fu">append</span>(fx_effects, rd_effects)</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(effects) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alpha_pp"</span>, <span class="fu">paste</span>(<span class="st">"v_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(A_pp), <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>effects_pred <span class="ot">&lt;-</span> effects</span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>effects_pred[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="at">times =</span> n_pts_pred)</span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Stacks for `y` are similar to before; however, stacks for `pp` have different structures for `A` and `effects`</span></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>stk_y_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est_y"</span>,</span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(data_USA<span class="sc">$</span>mean, <span class="cn">NA</span>), <span class="at">e =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts)),</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, ymat),</span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts), <span class="at">s =</span> indx)) </span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>stk_y_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred_y"</span>,</span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred), <span class="cn">NA</span>), <span class="at">e =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred)),</span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A_pp_p_base),</span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred), <span class="at">s =</span> indx)) </span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>stk_pp_e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"est_pp"</span>,</span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="cn">NA</span>, y_pp), <span class="at">e =</span> e_pp),</span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">append</span>(<span class="dv">1</span>, A_pp),</span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> effects)</span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a>stk_pp_p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">tag =</span> <span class="st">"pred_pp"</span>,</span>
<span id="cb161-37"><a href="#cb161-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="fu">cbind</span>(<span class="cn">NA</span>, <span class="fu">rep</span>(<span class="cn">NA</span>, n_pts_pred)), <span class="at">e =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_pts_pred)),</span>
<span id="cb161-38"><a href="#cb161-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">A =</span> <span class="fu">append</span>(<span class="dv">1</span>, A_pp_p),</span>
<span id="cb161-39"><a href="#cb161-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">effects =</span> effects_pred)</span>
<span id="cb161-40"><a href="#cb161-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-41"><a href="#cb161-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Full stack</span></span>
<span id="cb161-42"><a href="#cb161-42" aria-hidden="true" tabindex="-1"></a>stk_full_pp_y <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_y_e, stk_y_p, stk_pp_e, stk_pp_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let us fit the model. In this case, although the formula has a similar structure to what we used for the PS model, we also build it dynamically, as it depends on the number of basis functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">paste</span>(<span class="st">"f(v_"</span>,  <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(A_pp), <span class="st">", copy = </span><span class="sc">\"</span><span class="st">s</span><span class="sc">\"</span><span class="st">, fixed = FALSE, hyper = list(beta = re_prior))"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">collapse =</span> <span class="st">" + "</span>)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"y ~ 0 + mu + alpha_pp + f(s, model = spde) + "</span>, random_effects, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>formula_1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> formula_1))</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>formula_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>y ~ 0 + mu + alpha_pp + f(s, model = spde) + f(v_1, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_2, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_3, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_4, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_5, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_6, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_7, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_8, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_9, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_10, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_11, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_12, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_13, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_14, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior)) + f(v_15, copy = "s", 
    fixed = FALSE, hyper = list(beta = re_prior))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>model_7_1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(<span class="at">formula =</span> formula_1,</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family  =</span> <span class="fu">c</span>(<span class="st">"gaussian"</span>, <span class="st">"poisson"</span>), </span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">E =</span> <span class="fu">inla.stack.data</span>(stk_full_pp_y)<span class="sc">$</span>e,</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full_pp_y), </span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">link =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="fu">c</span>((n_pts <span class="sc">+</span> n_pts_pred), (n_vtx <span class="sc">+</span> n_pts <span class="sc">+</span> n_pts_pred))),</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk_full_pp_y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>model_7_1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"models/model_7_1.RDS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_7_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 5.26, Running = 1269, Post = 3.26, Total = 1278 
Fixed effects:
           mean    sd 0.025quant 0.5quant 0.975quant   mode kld
mu        5.453 0.226      4.933    5.471      5.836  5.511   0
alpha_pp -9.820 0.115    -10.057   -9.818     -9.594 -9.818   0

Random effects:
  Name    Model
    s SPDE2 model
   v_1 Copy
   v_2 Copy
   v_3 Copy
   v_4 Copy
   v_5 Copy
   v_6 Copy
   v_7 Copy
   v_8 Copy
   v_9 Copy
   v_10 Copy
   v_11 Copy
   v_12 Copy
   v_13 Copy
   v_14 Copy
   v_15 Copy

Model hyperparameters:
                                            mean      sd 0.025quant 0.5quant
Precision for the Gaussian observations    0.482   0.029      0.427    0.481
Range for s                             1522.722 430.223    858.456 1462.383
Stdev for s                                1.812   0.331      1.256    1.779
Beta for v_1                               0.278   0.187     -0.096    0.280
Beta for v_2                               0.453   0.427     -0.381    0.450
Beta for v_3                              -0.323   1.010     -2.340   -0.313
Beta for v_4                               0.819   0.262      0.312    0.817
Beta for v_5                               0.958   0.651     -0.322    0.957
Beta for v_6                               0.213   0.255     -0.292    0.214
Beta for v_7                               1.645   0.208      1.239    1.643
Beta for v_8                              -0.839   0.446     -1.733   -0.834
Beta for v_9                               0.737   0.445     -0.124    0.732
Beta for v_10                              0.310   0.209     -0.096    0.309
Beta for v_11                             -0.773   0.290     -1.349   -0.771
Beta for v_12                             -0.162   0.643     -1.440   -0.158
Beta for v_13                              0.483   1.218     -1.967    0.501
Beta for v_14                             -0.777   0.374     -1.514   -0.777
Beta for v_15                              0.155   1.079     -1.926    0.140
                                        0.975quant     mode
Precision for the Gaussian observations      0.541    0.479
Range for s                               2538.049 1346.647
Stdev for s                                  2.557    1.711
Beta for v_1                                 0.642    0.288
Beta for v_2                                 1.302    0.440
Beta for v_3                                 1.636   -0.271
Beta for v_4                                 1.343    0.805
Beta for v_5                                 2.243    0.954
Beta for v_6                                 0.713    0.218
Beta for v_7                                 2.059    1.637
Beta for v_8                                 0.024   -0.812
Beta for v_9                                 1.627    0.711
Beta for v_10                                0.726    0.302
Beta for v_11                               -0.207   -0.764
Beta for v_12                                1.093   -0.141
Beta for v_13                                2.827    0.578
Beta for v_14                               -0.042   -0.775
Beta for v_15                                2.323    0.077

Marginal log-Likelihood:  -10874.97 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<section id="prediction-3" class="level3">
<h3 class="anchored" data-anchor-id="prediction-3">Prediction</h3>
<p>Finally, we can retrieve the (1) fitted values, (2) estimated intensity process, and (3) estimated preferentiality surface <span class="math inline">\hat{\gamma}(x)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted values and prediction</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Response</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>idx_y  <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full_pp_y, <span class="at">tag =</span> <span class="st">"pred_y"</span> )<span class="sc">$</span>data</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>pred_y_mm  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"mean"</span>]))</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>pred_y_ll  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"0.025quant"</span>]))</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>pred_y_uu  <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_y,  <span class="st">"0.975quant"</span>]))</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_y_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_y_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_y_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>pp_y_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>)</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>pp_y_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>)</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>pp_y_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_y_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>)</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>(pp_y_ll <span class="sc">+</span> pp_y_mm <span class="sc">+</span> pp_y_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-126-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Intensity process</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>idx_pp <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk_full_pp_y, <span class="at">tag =</span> <span class="st">"pred_pp"</span>)<span class="sc">$</span>data</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>pred_pp_mm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"mean"</span>]))</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>pred_pp_ll <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.025quant"</span>]))</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>pred_pp_uu <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, model_7_1<span class="sc">$</span>summary.fitted.values[idx_pp, <span class="st">"0.975quant"</span>]))</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected number of observations</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pred_pp_mm<span class="sc">$</span>V3 <span class="sc">*</span> (<span class="dv">25</span> <span class="sc">**</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 903.119</code></pre>
</div>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>r_mm <span class="ot">&lt;-</span> pred_pp_mm<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>r_ll <span class="ot">&lt;-</span> pred_pp_ll<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>r_uu <span class="ot">&lt;-</span> pred_pp_uu<span class="sc">$</span>V3 <span class="sc">%&gt;%</span> <span class="fu">range</span>()</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(r_mm[<span class="dv">1</span>], r_ll[<span class="dv">1</span>], r_uu[<span class="dv">1</span>]), <span class="fu">max</span>(r_mm[<span class="dv">2</span>], r_ll[<span class="dv">2</span>], r_uu[<span class="dv">2</span>]))</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>pp_pp_mm <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"Mean"</span>,   <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>pp_pp_ll <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_ll, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"2.5th"</span>,  <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>pp_pp_uu <span class="ot">&lt;-</span> <span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pred_pp_uu, <span class="at">USA =</span> USA, <span class="at">r =</span> r, <span class="at">tt =</span> <span class="st">"97.5th"</span>, <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>(pp_pp_ll <span class="sc">+</span> pp_pp_mm <span class="sc">+</span> pp_pp_uu) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-126-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The estimated preferentiality surface <span class="math inline">\hat{\gamma}(x)</span> is determined based on the pre-computed basis functions <span class="math inline">\{\phi_k(x)\}_k</span> and the posterior mean of <span class="math inline">\{\beta_k\}_k</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>n_basis_functions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>n_hyperparameter <span class="ot">&lt;-</span> <span class="fu">nrow</span>(model_7_1<span class="sc">$</span>summary.hyperpar)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>coeff <span class="ot">&lt;-</span> model_7_1<span class="sc">$</span>summary.hyperpar[((n_hyperparameter <span class="sc">-</span> n_basis_functions <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n_hyperparameter), <span class="st">"mean"</span>]</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>value <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n_pts_pred) </span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_basis_functions) {</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>  bfs_pred_tmp <span class="ot">&lt;-</span> bfs_pred[[i]]</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>  value <span class="ot">&lt;-</span> value <span class="sc">+</span> (bfs_pred_tmp <span class="sc">*</span> coeff[i])</span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>pref_mm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(coord_pred, value))</span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pred_USA</span>(<span class="at">fitted_values =</span> pref_mm, <span class="at">USA =</span> USA, <span class="at">r =</span> <span class="fu">range</span>(pref_mm<span class="sc">$</span>value), <span class="at">tt =</span> <span class="st">"Preferentiality surface"</span>, <span class="at">should_round =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>